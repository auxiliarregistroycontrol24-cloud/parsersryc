import tkinter as tk
from tkinter import filedialog, scrolledtext, messagebox, ttk
import queue
import asyncio
import shutil
from unstract.llmwhisperer import LLMWhispererClientV2
from unstract.llmwhisperer.client_v2 import LLMWhispererClientException
import pandas as pd
import requests
import json
import re
import os
import traceback
import unicodedata
import threading
import time
import subprocess
from dotenv import load_dotenv
import google.generativeai as genai

load_dotenv()

# --- Configuraci√≥n y variables globales ---
LLMWHISPERER_API_KEY_1 = os.getenv("LLMWHISPERER_API_KEY_1")
LLMWHISPERER_API_KEY_2 = os.getenv("LLMWHISPERER_API_KEY_2")
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
OPENROUTER_API_KEY_2 = os.getenv("OPENROUTER_API_KEY_2")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 

OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"

# --- CONFIGURACI√ìN DE WORKERS Y MODELOS ---
WORKER_MODELS = [
    #"deepseek/deepseek-chat-v3-0324:free",
    "moonshotai/kimi-k2:free",
    #"x-ai/grok-4-fast:free",
    "tngtech/deepseek-r1t2-chimera:free",
    #"tngtech/deepseek-r1t2-chimera:free",
    "deepseek/deepseek-r1-0528:free",
    "deepseek/deepseek-r1:free",
    "tngtech/deepseek-r1t-chimera:free",
    "meituan/longcat-flash-chat",
    "minimax/minimax-m2:free",
    "x-ai/grok-4.1-fast:free",
    #"openrouter/sherlock-dash-alpha", 
    #"openrouter/sherlock-think-alpha",
    #"openrouter/polaris-alpha",
    #"nvidia/nemotron-nano-12b-v2-vl:free",
    #"deepseek/deepseek-chat-v3.1:free",
    #"openai/gpt-oss-120b:free",
    #"deepseek/deepseek-r1-0528-qwen3-8b:free",
    #"deepseek/deepseek-r1-distill-llama-70b:free",
    #"deepseek/deepseek-r1-distill-qwen-14b:free",
    #"qwen/qwen3-235b-a22b:free",
    #"openai/gpt-oss-20b:free",
    #"nvidia/nemotron-nano-9b-v2:free",
]

MAX_WORKERS = len(WORKER_MODELS)

YOUR_SITE_URL = "https://github.com/tu_usuario/tu_proyecto"
YOUR_SITE_NAME = "Procesador AHK"

PROGRAMAS_VERDES = {
    "administraci√≥n de empresas", "administracion de empresas", "ingenieria de sistemas", "ingenieria de software",
    "ingenier√≠a de software", "de software", "ingenieria industrial", "ingenier√≠a industrial", "ingenieria en ciencia de datos", "ingenier√≠a en ciencia de datos",
    "licenciatura en ciencias sociales", "licenciatura en educaci√≥n infantil", "licenciatura en educacion infantil",
    "licenciatura en matem√°ticas", "licenciatura en matematicas", "licenciatura en infantil", "mercadeo y publicidad",
    "negocios internacionales", "derecho", "administraci√≤n financiera virtual", "administraci√≥n financiera virtual",
    "administracion financiera virtual", "administracion financiera", "administraci√≥n financiera", "financiera virtual", "administracion en salud",
    "administraci√≥n en salud", "administraci√≥n en salud virtual", "especializacion en auditoria en salud",
    "especializaci√≥n en auditoria en salud", "esp en marketing digital vir", "adminsitraci√≥n financiera"
}

PALABRAS_CLAVE_POSGRADO = {"maestria", "especializacion", "esp", "posgrado"}

ABREVIATURAS_PREDEFINIDAS = {
    "TECNICO EN CONTABILIZACION DE OPERACIONES COMERCIALES Y FINANCIERAS": "TC CONTAB OPERA COMER Y FINANC",
    "TECN√ìLOGO EN GESTION CONTABLE Y FINANCIERA": "TG EN GSTON CONTBLE Y FINACIRA",
    "TECNOLOGO EN ANALISIS Y DESARROLLO DE SOFTWARE": "TG ANALISIS Y DESARR DE SOFTWA",
    "TECNOLOGO EN ANALISIS Y DESARROLLO DE SISTEMAS DE INFORMACI√ìN": "TG ANALISIS Y DESARR SIST INFO",
    "Tecnolog√≠a en Gesti√≥n Bancaria y de Entidades Financieras": "TG EN GSTON BANCARIA Y FINANCI",
    "TECN√ìLOGO EN GESTION CONTABLE Y DE INFORMACION FINANCIERA": "TG EN GSTON CONTBLE INFO FINAN",
    "T√âCNICO EN SEGURIDAD VIAL, CONTROL DE TRANSITO Y TRANSPORTE": "TC SEGU VIAL CTRL TRANSIT TRAN",
    "TECNOLOGIA EN GESTION DE LA SEGURIDAD Y SALUD EN EL TRABAJO": "TG EN GSTON SEG SLUD EN TRABA",
    "TECNOLOGO EN GESTI√ìN INTEGRADA DE LA CALIDAD, MEDIO AMBIENTE, SEGURIDAD Y SALUD OCUPACIONAL": "TG GSTN CALID AMBI SEG Y SALD",
    "TECN√ìLOGO EN GESTI√ìN DEL TALENTO HUMANO": "TG EN GSTON DEL TLENTO HUMANO",
    "T√âCNICO EN SOLDADURA DE PRODUCTOS MET√ÅLICOS": "TC EN SOLDADUR PRODUCT METALIC",
    "T√âCNICO EN ATENCI√ìN INTEGRAL A LA PRIMERA INFANCIA": "TC ATENCION INTGRL PRIME INFAN",
    "TECNICO LABORAL EN EDUCACION PARA LA PRIMERA INFANCIA": "TC EN EDUCION PRIMERA INFANCIA",
    "Especializaci√≥n en educaci√≥n e intervenci√≥n para la primera infancia.": "ESP EDUCION INTRCION PRIME INF",
    "TECNOLOGO EN CONTABILIDAD Y FINANZAS": "TG EN CONTABILIDAD Y FINANZAS",
    "T√âCNICO INTEGRACION DE CONTENIDOS DIGITALES": "TC INTGRCION CNTENIDOS DIGITAL",
    "T√âCNICO EN ASISTENCIA ADMINISTRATIVA": "TC EN ASTENCIA ADMINISTRATIVA",
    "TECNICO EN ASISTENCIA ADMINISTRATIVA": "TC EN ASTENCIA ADMINISTRATIVA",
    "TECN√ìLOGO EN GESTI√ìN ADMINISTRATIVA": "TG GESTION ADMINISTRATIVA",
    "TECNOLOGIA EN GESTI√ìN ADMINISTRATIVA": "TG GESTION ADMINISTRATIVA",
    "TECNOLOG√çA EN GESTI√ìN ADMINISTRATIVA": "TG GESTION ADMINISTRATIVA",
    "TECNOLOG√çA EN GESTI√ìN INTEGRADA DE LA CALIDAD, MEDIO AMBIENTE, SEGURIDAD Y SALUD OCUPACIONAL": "TG GSTN CALID AMBI SEG Y SALD",
    "TECNOLOGO EN ACTIVIDAD FISICA": "TG EN ACTIVIDAD FISICA",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILIAR ADMINISTRATIVO EN SALUD": "TC LABRAL AUX ADMINIST SALUD",
    "T√âCNICO LABORAL POR COMPETENCIAS EN LOG√çSTICA Y ADMINISTRACI√ìN DE ALMACENES": "TC LABRAL LOGISTI Y ADM ALMACE",
    "TECNICO LABORAL POR COMPETENCIAS EN EDUCACION INICIAL Y RECREACION": "TC EN EDUCION INCIAL RECRCION",
    "TECNOLOG√çA EN MANTENIMIENTO ELECTROMEC√ÅNICO INDUSTRIAL": "TG EN MANTEMTO ELECTRMC INDUS",
    "TECNICO EN SISTEMAS AGROPECUARIOS ECOLOGICOS": "TC EN SISTEMA AGROPECU ECOLOGI",
    "T√âCNICO EN PROGRAMACION DE APLICACIONES PARA DISPOSITIVOS MOVILES": "TC PROGRAM APLICAC DISPOS MOVI",
    "T√âCNICO EN PROGRAMACI√ìN DE SOFTWARE": "TC PROGRAMACI√ìN DE SOFTWARE",
    "TECNICO EN PROGRAMACION DE SOFTWARE": "TC PROGRAMACI√ìN DE SOFTWARE",
    "T√âCNICO EN PROGRAMACION DE SOFTWARE": "TC PROGRAMACI√ìN DE SOFTWARE",
    "Tecnolog√≠a en Gesti√≥n Financiera y Tesorer√≠a": "TG EN GSTON FINACIRA Y TESORIA",
    "TECNOLOG√çA EN COORDINACI√ìN DE PROCESOS LOG√çSTICOS": "TG EN COORDN PRCSOS LOGISTIC",
    "T√âCNICO EN SERVICIOS COMERCIALES Y FINANCIEROS": "TC EN SERVICI COMERC Y FINANCI",
    "TECN√ìLOGO EN GESTI√ìN INTEGRADA DE LA CALIDAD, MEDIO AMBIENTE, SEGURIDAD Y SALUD OCUPACIONAL": "TG GSTN CALID AMBI SEG Y SALD",
    "TECN√ìLOGO EN DISE√ëO DE ELEMENTOS MEC√ÅNICOS PARA SU FABRICACI√ìN CON M√ÅQUINAS HERRAMIENTAS CNC": "TG DIS√ë ELE MEC MAQU HER CNC",
    "TECN√ìLOGO EN MANTENIMIENTO DE EQUIPOS DE COMPUTO, DISE√ëO E INSTALACION DE CABLEADO ESTRUCTURADO": "TG MANTO EQUIP COMP CABL ESTRU",
    "INGENIERIA EN SEGURIDAD INDUSTRIAL E HIGIENE OCUPACIONAL": "ING EN SEG INDU Y SALUD OCUPAC",
    "TECNICO EN ASESOR√çA COMERCIAL Y OPERACIONES DE ENTIDADES FINANCIERAS": "TC EN ASERIA COMR OPER ENT FIN",
    "TECNICO LABORAL EN AUXILIAR ADMINISTRATIVO EN SALUD": "TC LAB EN AUX ADMINIST EN SALD",
    "TECN√ìLOGO EN GESTION DE PROYECTOS DE DESARROLLO ECONOMICO Y SOCIAL": "TG GSTN PROY DESRRLL ECO SOC",
    "T√âCNICO PROFESIONAL EN MANTENIMIENTO ELECTR√ìNICO INDUSTRIAL": "TC EN MNTMTO ELECTRO INDSTRL",
    "T√âCNICO EN MANEJO INTEGRAL DE RESIDUOS SOLIDOS": "TC MANEJO INTGRL RESIDU SOLID",
    "TG EN GESTION DE PROCESOS ADMINISTRATIVOS DE SALUD": "TG GSTON PROCE ADMINI DE SALUD",
    "TECNOLOG√çA EN DESARROLLO DE SOFTWARE Y APLICATIVOS M√ìVILES": "TG EN DSRLLO SOFT Y APLICA MOV",
    "TECNICO LABORAL POR COMPETENCIA EN AUXILIAR EN ENFERMERIA": "TC LAB POR COMP EN AUX ENFERME",
    "T√âCNICO EN OPERACI√ìN DE MAQUINARIA PESADA PARA EXCAVACI√ìN": "TC OPERAC MAQUI PESAD EXCAVA",
    "Especializaci√≥n en Desarrollo integral de la infancia y la adolescencia": "ESP EN DESRRLL INTG INF Y ADOL",
    "ESPECIALIZACI√ìN EN ADMINISTRACI√ìN DE LA INFORM√ÅTICA EDUCATIVA": "ESP ADMON DE LA INFORM EDUC",
    "T√âCNICO EN SEGURIDAD Y SALUD EN EL TRABAJO": "TC EN SEGU Y SALD EN EL TRABAJ",
    "TECN√ìLOGO EN DISE√ëO, IMPLEMENTACI√ìN Y MANTENIMIENTO DE SISTEMAS DE TELECOMUNICACIONES": "TG DIS√ë IMPLEM MANT SIS Y TELE",
    "TECN√ìLOGO EN SALUD OCUPACIONAL": "TG EN SALUD OCUPACIONAL",
    "Tecnolog√≠a en Coordinaci√≥n de Servicios Hoteleros": "TG EN COORDIN DE SERVIC HOTELR",
    "T√âCNICO LABORAL POR COMPETENCIAS EN GESTOR COMUNITARIO Y SOCIAL": "TC LBRL COMP GSTR COMN Y SOCIL",
    "TECNOLOGO EN GESTI√ìN ADMINISTRATIVA DEL SECTOR SALUD": "TG EN GSTON ADMTIVA SECT SALUD",
    "ESPECIALIZACION EN BIGDATA Y ANALITICA VIRTUAL": "ESP BIGDATA Y ANALTICA VIRTUAL",
    "TECN√ìLOGO EN SISTEMAS DE GESTI√ìN AMBIENTAL": "TG EN SISTEMA GSTON AMBIENTAL",
    "TECNICO EN APOYO ADMINISTRATIVO EN SALUD": "TC EN APOYO ADMINTIVO EN SALD",
    "TECNICO PROFESONAL EN SEGURIDAD Y SALUD EN EL TRABAJO": "TC PROF SEG Y SALD EN EL TRABJ",
    "T√âCNICO DE OPERACIONES DE COMERCIO EXTERIOR": "TC DE OPERAC COMER EXTERIOR",
    "TECN√ìLOGO EN MANTENIMIENTO ELECTR√ìNICO E INSTRUMENTAL INDUSTRIAL": "TG MNTMTO ELECT E INSTRUM INDU",
    "ESPECIALIZACI√ìN EN PEDAGOG√çA DE LA RECREACI√ìN ECOL√ìgica": "ESP EN PEDAG DE LA RECRE ECOLG",
    "Especializaci√≥n en Neuropsicolog√≠a de la educaci√≥n": "ESP NEUROPSICO DE LA EDUCACION",
    "T√âCNICO EN MONTAJE Y MANTENimiento DE REDES AEREAS DE DISTRIBUCI√ìN DE ENERG√çA ELECTRICA": "TC MONT MTNTO RDES AERE DISTR",
    "TECNOLOG√çA EN GESTI√ìN DE SALUD OCUPACIONAL, SEGURIDAD Y MEDIO AMBIENTE": "TG GSTN SALD OCUP SEG MED AMB",
    "T√âCNICO EN IMPLEMENTACION Y MANTENIMIENTO DE EQUIPOS ELECTRONICOS INDUSTRIALES": "TC IMPL MANTNTO EQU ELEC INDUS",
    "TECNICO LABORAL POR COMPETENCIAS AUXILIAR EN RECURSOS HUMANOS": "TC LAB COMPETE AUX EN REC HUMA",
    "T√âCNICO EN MANTENIMIENTO DE MAQUINAS DE CONFECCI√ìN INDUSTRIAL": "TC MTNTO MAQUI CONFECC INDUSTR",
    "TECNOLOG√çA EN MANTENIMIENTO MECATR√ìNICO DE AUTOMOTORES": "TG EN MTNTO MECATRNICO AUTOMOT",
    "T√âCNICO LABORAL POR COMPETENCIAS EN ATENCI√ìN INTEGRAL A LA PRIMERA INFANCIA": "TC COMP ATNCN INTGRL PRIM INFA",
    "TECNICO LABORAL EN ATENCI√ìN INTEGRAL A LA PRIMERA INFANCIA": "TC LAB ATNCON INTGRL PRIM INFA",
    "TECNICO LABORAL POR COMPETENCIAS EN CONTABLE Y FINANCIERO": "TC LAB POR COMP CONTABL Y FINA",
    "TECNICO PROFESIONAL EN OPERACIONES CONTABLES": "TC PROF EN OPERACIO CONTABLES",
    "TECNICO LABORAL POR COMPETENCIAS EN SEGURIDAD OCUPACIONAL": "TC LAB POR COMP EN SEG OCUPACI",
    "TEÃÅCNICO EN PRESELECCION DE TALENTO HUMANO MEDIADO POR HERRAMIENTAS TIC": "TC PRESELECC TLTO HUM HERR TIC",
    "T√âCNICO EN INSTALACION Y MANTENIMIENTO DE EQUIPOS PARA INSTRUMENTACION INDUSTRIAL": "TC INSTL MNTO EQUIP INSTRU IND",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILILAR ADMINISTRATIVO": "TC LAB POR COMP EN AUX ADMON",
    "T√âCNICO EN MANTENIMIENTO DE EQUIPOS DE C√ìMPUTO": "TG EN MANTENIMTO EQUIP COMP",
    "TECNICO LABORAL POR COMPETENCIAS EN ELECTRICISTA INDUSTRIAL": "TC LAB POR COMP EN ELECTR IND",
    "T√âCNICO EN INTEGRACI√ìN DE OPERACIONES LOGISTICAS": "TC EN INTGRAC DE OPERA LOGISTI",
    "T√âCNICO EN MONTAJE Y MANTENIMIENTO ELECTROMECANico DE INSTALACIONES MINERAS BAJO TIERRA": "TC MONTJE MNTO ELECTR INST MIN",
    "ESPECIALIZACI√ìN EN L√öDica Y RECREACI√ìN PARA EL DESARROLLO SOCIAL Y CULTURAL": "ESP LUD RCRE DESARR SOCI Y CUL",
    "TECN√ìLOGO GESTION PARA ESTABLECIMIENTOS DE ALIMENTOS Y BEBIDAS": "TG GSTON ESTBLCI ALIMNT Y BEBD",
    "T√âCNICO EN INSTALACIONES ELECTRICAS RESIDENCIALES": "TC EN INSTALC ELECTRIC RESIDEN",
    "T√âCNICO EN ASISTENCIA EN ORGANIZACI√ìN DE ARCHIVO": "TC ASISTEN ORGANIZ DE ARCHIVO",
    "TECNOLOG√çA EN DISE√ëO E INTEGRACI√ìN DE AUTOMATISMOS MECATR√ìNICOS": "TC DISE√ë INTGRC AUTOM MECATR",
    "TECNOLOG√çA EN DISTRIBUCI√ìN F√çSICA INTERNACIONAL": "TG EN DISTRIBUC FISICA INTERNA",
    "TECNOLOGA EN COMERCIO EXTERIOR Y NEGOCIOS INTERNACIONALES": "TG EN COM EXTER Y NEGO INTERNA",
    "Tecnologo en mercadeo y dise√±o publicitario": "TG EN MERCADEO Y DISE√ëO PUBLIC",
    "Tecnologo Coordinador de Procesos Log√≠sticos": "TG COORDINADR PROCES LOGISTIC",
    "ESPECIALIZACION EN GERENCIA DE LA CALIDAD EN SALUD": "ESP GERNCIA DE CALDAD EN SALUD",
    "TECNOLOG√çA EN GESTION DE REDES DE DATOS": "TG GSTON DE REDES DATOS",
    "TECNOLOG√çA EN COMPUTACI√ìN Y DESARROLLO DE SOFTWARE": "TG COMPUTACI Y DESARR DE SOFTW",
    "TECNOLOG√çA EN GESTI√ìN DE LA PRODUCCI√ìN INDUSTRIAL": "TG GSTON DE LA PRODUC INDUSTRI",
    "TECNOLOG√çA EN QU√çMICA APLICADA A LA INDUSTRIA": "TG QUIMICA APLICD A LA INDUSTR",
    "TECN√ìLOG√çA EN LEVANTAMIENTOS TOPOGRAFICOS Y GEORREFERENCIACI√ìN": "TG LEVANTA TOPOGRA Y GEOREFERE",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILIAR EN EDUCACI√ìN PARA LA PRIMERA INFANCIA": "TC LAB POR COMP EDU PRIME INFA",
    "T√âCNICO EN AUXILIAR EN EDUCACI√ìN INTEGRAL PARA LA PRIMERA INFANCIA": "TC AUX EDUC INTGRL PRIME INFAN",
    "TECNICO LABORAL EN AUXILIAR DE SERVICIOS FARMACEUTICOS": "TC LAB EN AUX DE SERVIC FARMAC",
    "TECNICO LABORAL AUXILIAR EN SEGURIDAD Y SALUD EN EL TRABAJO": "TC LAB SEG Y SALUD EN EL TRAB",
    "T√©cnico en operaciones de log√≠stica comercial en grandes superficies": "TC EN OPER LOG COME GRAN SUPER",
    "TECNOLOG√çA EN ASEGURAMIENTO METROL√ìGICO INDUSTRIAL": "TG ASEGUR METROLOG INDUSTRIAL",
    "TECNOLOG√çA EN FOTOGRAF√çA Y PROCESOS DIGITALES": "TG EN FOTOGRAF Y PROCES DIGITA",
    "T√©cnico Desarrollo de Operaciones Log√≠sticas": "TC DESARR DE OPERACI LOGISTICS",
    "TECNOLOG√çA EN PROCESOS DE LA INDUSTRIA QU√çMICA": "TG EN PROCES DE INDUST QUIMICA",
    "T√âCNICO PROFESIONAL EN PROCESO ADMINISTRATIVO EN SALUD": "TC PROF PROCE ADMTVO EN SALUD",
    "Tecnolog√≠a en Gesti√≥n de la Propiedad Horizontal": "TG GSTON DE LA PROPIED HORIZO",
    "T√âCNICO EN MECANICO DE MAQUINARIA INDUSTRIAL": "TC MECANICO MAQUIN INDUSTRIAL",
    "T√âCNICO LABORAL POR COMPETENCIAS EN LOG√çSTICA Y PRODUCCI√ìN": "TC LAB POR COMP LOGIST Y PRODU",
    "T√âCNICO LABORAL POR COMPETENCIAS EN AUXILIAR CONTABLE Y FINANCIERO": "TC LAB COMPET AUX CONT Y FINAN",
    "TECNICO LABORAL EN AUXILIAR CONTABLE Y FINANCIERO": "TC LAB EN AUX CONTABL Y FINANC",
    "T√©cnico Desarrollo de Operaciones Log√≠sticas en la Cadena de Abastecimiento": "TC DESARR OPER LOG CADEN ABAST",
    "Tecnolog√≠a en Gesti√≥n Integral del Riesgo en Seguros": "TG GSTON INTGRL RISGO EN SEGUR",
    "ESPECIALIZACI√ìN EN ATENCI√ìN INTEGRAL A LA PRIMERA INFANCIA": "ESP ATCION INTGRL PRIMER INFAN",
    "TECNICO LABORAL POR COMPETENCIAS EN SEGURIDAD Y SALUD EN EL TRABAJO": "TC LAB COMPET SEG SLUD TRBJ",
    "T√âCNICO LABORAL POR COMPETENCIAS EN AUXILIAR DE PREESCOLAR": "TC LAB POR COMP AUX PREESC",
    "TECNICO PROFESIONAL EN SERVICIOS ADMINISTRATIVOS DE SALUD": "TC PROF SERVIC ADMIN SALUD",
    "ADMINISTRACI√ìN DE EMPRESAS NIVEL I T√âCNICO PROFESIONAL EN PROCESOS EMPRESARIALES": "TC PROF EN PROCES EMPRESAR",
    "TECNOLOG√çA EN CONSTRUCCI√ìN DE INFRAESTRUCTURA VIAL": "TG CONSTRU INFRAESTRUC VIAL",
    "TECN√ìLOGO EN GESTI√ìN DE RECURSOS EN PLANTAS DE PRODUCCI√ìN": "TG GSTON RECUR EN PLAN PRODUCC",
    "TECN√ìLOGO EN IMPLEMENTACION DE INFRAESTRUCTURA DE TECNOLOGIAS DE LA INFORMACION Y LAS COMUNICACIONES": "TG IMPL INFRA TECNO INFO COMUN",
    "T√âCNICO LABORAL EN AUXILIAR DE EDUCACI√ìN DE LA PRIMERA INFANCIA": "TC LAB EN AUX EDUC PRIMER INFA",
    "T√©cnico Laboral por competencias en Apoyo a la Primera Infancia": "TC LAB COMP APOY PRIMER INFAN",
    "TECNOLOG√çA EN GESTI√ìN DEL CICLO DE VIDA DEL PRODUCTO": "TG GSTON CICLO VIDA DEL PRODU",
    "TECNOLOG√çA EN PRODUCCI√ìN AGROPECUARIA ECOL√ìGICA": "TG EN PRODUCC AGROPEC ECOLO",
    "T√©cnico Laboral por Competencias en Banca y Servicios Financieros": "TC LAB COMPET BANC Y SER FINAN",
    "T√âCNICO PROFESIONAL EN ATENCI√ìN INTEGRAL A LA PRIMERA INFANCIA": "TC PROF ATNCIN INTGRL PRIM INF",
    "T√âCNICO EN OPERACION DE SERVICIOS EN CONTACT CENTER Y BPO": "TC OPER SERV CONTA CENT Y BPO",
    "T√âCNICO EN ALISTAMIENTO Y OPERACI√ìN DE MAQUINARIA PARA LA PRODUCCI√ìN INDUSTRIAL": "TC ALIMTO Y OPER MAQU PRO IND",
    "Especializaci√≥n en Planeaci√≥n Educativa y Planes de Desarrollo": "ESP EN PLANE EDUC PLAN DESARR",
    "ESPECIALIZACI√ìN EN INVESTIGACI√ìN E INNOVACI√ìN EDUCATiva": "ESP EN INVSTG INNOVAC EDUCATIV",
    "TECNOLOGO EN SUPERVISI√ìN EN PROCESOS DE CONFECCI√ìN": "TG EN SUPERVI PROCES DE CONFEC",
    "TECNICO LABORAL EN ATENCION A LA PRIMERA INFANCIA": "TC LAB ATNCION PRIMERA INFANCI",
    "TECNICO LABORAL POR COMPETENCIAS EN TRABAJO SOCIAL Y COMUNITARIO": "TC LAB COMPT TRAB SOCIAL Y COM",
    "TECNICO LABORAL POR COMPETENCIAS EN ASISTENCIA ADMINISTRATIVA": "TC LAB POR COMP ASISTEN ADMIN",
    "TECNICO LABORAL POR COMPETENCIAS EN ASISTENTE ADMINISTRATIVO": "TC LAB POR COMPET ASISTE ADMIN",
    "ESPECIALIZACION EN METODOS Y TECNICAS DE INVESTIGACION EN CIENCIAS SOCIALES": "ESP MET Y TEC INVST CIENC SOCI",
    "T√âCNICO LABORAL POR COMPETENCIAS EN ATENCI√ìN A LA PRIMERA INFANCIA": "TC LAB COMP ATNCIN PRIMR INFA",
    "ESPECIALIZACI√ìN EN EVALUACI√ìN E INTERVENCI√ìN PSICOEDUCATIVA": "ESP EVALUA E INTERVE PSICOEDU",
    "TECNOLOGO EN GESTION DE OPERACIONES EN TERMINALES PORTUARIAS": "TG GSTON OPERACIO TERM PORTU",
    "TECNICO LABORAL COMO AUXILIAR EN EL DESARROLLO DE LA PRIMERA INFANCIA": "TC LAB AUX DESARR PRIME INFANC",
    "TECN√ìLOGO EN DESARROLLO DE MEDIOS GRAFICOS VISUALES": "TG DESARR DE MEDI GRAF VISUALE",
    "T√âCNICO LABORAL ASISTENTE EN DESARROLLO DE SOFTWARE": "TC LAB ASISTE DEASRR DE SOFTW",
    "T√âCNICO LABORAL POR COMPETENCIAS AUXILIAR EN ATENCI√ìN A LA PRIMERA INFANCIA": "TC LAB COMP AUX ATNCN PRIM INF",
    "TECN√ìLOGO EN CONTROL DE CALIDAD EN LA INDUSTRIA DE ALIMENTOS": "TG CONTRL CALID IND ALIMENTOS",
    "TECN√ìLOGO EN SUPERVISI√ìN DE REDES DE DISTRIBUCI√ìN DE ENERG√çA EL√âCTRICA": "TG SUPER RED DISTR ENER ELECT",
    "TECNICO LABORAL POR COMPETENCIAS COMO AUXILIAR EN TALENTO HUMANO, SEGURIDAD Y SALUD EN EL TRABAJO": "TC LAB COMP AUX TL HUM SST",
    "TECNICO EN MANTENIMIENTO DE EQUIPOS DE REFRIGERACI√ìN, VENTILACI√ìN Y CLIMATIZACI√ìN": "TC MANTO EQUPO REFRG VENT CLI",
    "TECNICO LABORAL POR COMPETENCIAS EN ASISTENCIA EN ATENCI√ìN A LA PRIMERA INFANCIA": "TC LAB COMPT ASIS ATNC PRM INF",
    "T√âCNICO LABORAL EN AUXILIAR EN SEGURIDAD OCUPACIONAL": "TC LAB AUX SEGUR OCUPACIONAL",
    "TECNOLOG√çA EN GESTI√ìN DE SISTEMAS DE INFORMACI√ìN Y REDES DE COMPUTO": "TG GSTON SIST INF Y REDES COMP",
    "T√âCNICO LABORAL POR COMPETENCIAS EN ASISTENTE EN ATENCI√ìN INTEGRAL A LA PRIMERA INFANCIA": "TC LAB COM ATEN INTGR PRI INFA",
    "TECNICO LABORAL POR COMPETENCIAS EN SEGURIDAD OCUPACIONAL Y LABORAL": "TC LAB COMP SEGU OCUP Y LAB",
    "T√âCNICO LABORAL POR COMPETENCIAS EN CONTABILIDAD Y FINANZAS": "TC LAB COMPT CONTABI Y FINANZ",
    "TECN√ìLOGO EN SUPERVISI√ìN EN SISTEMAS DE AGUA Y SANEAMIENTO": "TG SUPERV SISTE AGU Y SANEAMIE",
    "TECNICO LABORAL EN √ÅNALISIS Y SISTEMAS DE INFORMACI√ìN": "TC LAB ANALI Y SISTEMAS INFORM",
    "T√âCNICO EN SERVICIOS Y OPERACIONES MICROFINANCIERAS": "TC EN SERV Y OPERAC MICROFINA",
    "T√âCNICO LABORAL POR COMPETENCIAS COMO REVISADOR DE CALIDAD": "TC LAB POR COMPET REVISA CALID",
    "TECNOLOGO EN IMPLEMENTACION DE REDES Y SERVICIOS DE TELECOMUNICACIONES": "TG IMPLTC REDE Y SERV DE TELEC",
    "TECN√ìLOGO EN IMPLEMENTACI√ìN DE INFRAESTRUCTURA DE TECNOLOG√çAS DE LA INFORMACI√ìN Y LAS COMUNICACIONES": "TG IMPLEM INFRA TEC INFOR COM",
    "T√âCNICO EN BILINGUAL EXPERT ON BUSINESS PROCESS OUTSOURCING": "TC BILG EXPT ON BUSIN PRO OUT",
    "TECNOLOGIA EN GESTION DE SISTEMAS DE TELECOMUNICACIONES": "TG GSTON SISTEM DE TELECOMU",
    "T√âCNICO DESARROLLO DE OPERACIONES LOG√çSTICA EN LA CADENA DE ABASTECIMIENTO": "TC DESAR OPRC LOGST CADN AB",
    "T√âCNICO LABORAL POR COMPETENCIAS EN EDUCACI√ìN PARA LA PRIMERA INFANCIA": "TC LAB COMPT EDUC PRIM INFAN",
    "TECNOLOGO EN GESTION BANCARIA Y DE ENTIDADES FINANCIERAS": "TG GSTON BANC ENTIDA FINANCI",
    "Tecnolog√≠a en Gesti√≥n de Proyectos de Desarrollo Econ√≥mico y Social": "TG GSTON PROYE DESAR ECON SOC",
    "T√âCNICO LABORAL AUXILIAR EN CUIDADO DE NI√ëOS - PRIMERA INFANCIA": "TC LAB AUX CUID NI√ëOS PRIM INF",
    "TECN√ìLOGO EN CONTROL DE CALIDAD EN DE ALIMENTOS": "TG CTRL CALIDAD DE ALIMENTOS",
    "TECNICO EN ATENCION INTEGRAL A LA PRIMERA INFANCIA": "TC ATNCION INTGRL PRIME INFAN",
    "TECNOLOG√çA EN GESTI√ìN CONTABLE Y DE INFORMACI√ìN FINANCIERA": "TG GSTON CONTABLE INFO FINAN",
    "TECNICO LABORAL POR COMPETENCIAS EN TRABAJO SOCIAL Y COMUNITARIO SGC": "TC LAB COMPT TRA SOC COM SGC",
    "Tecnolog√≠a en Gesti√≥n Bancaria y Entidades Financieras": "TG GSTON BANC Y ENTID FINANCIE",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILIAR EN SERVICIOS FARMACEUTICOS": "TC LAB COMPT AUX SER FARMACEU",
    "T√âCNICO EN PRESELECCION DE TALENTO HUMANO MEDIADO POR HERRAMIENTAS TIC": "TC PRESELEC TLTO HUM MED TIC",
    "T√©cnico Laboral por Competencias en: AUXILIAR DE PREESCOLAR": "TC LAB COMP AUX PREESCOLAR",
    "TECNOLOG√çA EN AUTOMATIZACI√ìN INDUSTRIAL": "TG AUTOMATIZAC INDUSTRIAL",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILIAR DE EDUCACI√ìN PARA LA PRIMERA INFANCIA": "TC LAB COMPT AUX EDU PRIM INF",
    "TECN√ìLOGO EN ENTRENAMIENTO DEPORTIVO": "TG ENTRENAMTO DEPORTIVO",
    "T√©cnico Contabilizaci√≥n de Operaciones Comerciales y Financieras": "TC CONTAB OPER COMER Y FINAN",
    "T√âCNICO EN OPERACIONES DE COMERCIO EXTERIOR": "TC OPERACIO COMERC EXTERIOR",
    "TECNICO LABORAL POR COMPETENCIS EN AUXILIAR DE EDUCACI√ìN PARA LA PRIMERA INFANCIA": "TC LAB COMPT AUX EDU PRIM INFA",
    "T√©cnico Laboral en AUXILIAR CONTABLE Y FINANCIERO": "TC LAB AUX CONTAB Y FINANCIERO",
    "TECN√ìLOGO GESTION CONTABLE Y DE INFORMACION FINANCIERA": "TG GSTON CONTABL Y INFO FINANC",
    "T√âCNICO EN DESARROLLO DE OPERACIONES EN LA CADENA DE ABASTECIMIENTO": "TC DESARR OPERAC CADEN ABASTC",
    "T√âCNICO EN OPERACI√ìN DE SERVICIOS EN CONTACT CENTER Y BPO": "TC OPERAC SERV CONTC CENT BPO",
    "TECN√ìLOGO EN MANTENIMIENTO MECATR√ìNICO DE AUTOMOTORES": "TG MANTO MECATRCO DE AUTOMTO",
    "T√âCNICO LABORAL POR COMPETENCIAS EN ATENCION A LA PRIMERA INFANCIA": "TC LAB COMPT ATNC PRIMER INFAN",
    "LICENCIATURA EN PEDAGOG√çA INFANTIL VIRTUAL": "LIC PEDAGOGIA INFANTIL VIRTUAL",
    "T√âCNICO PROFESIONAL EN SERVICIO DE POLIC√çA DE LA DIRECCI√ìN NACIONAL DE ESCUELAS": "TC PROF SERV POLIC DIR NAC ESC",
    "T√âCNICO EN CONTABILIZACION DE OPERACIONES COMERCIALES Y FINANCIERA": "TC CONT OPERAC COMER Y FINAN",
    "T√âCNICO LABORAL POR COMPETENCIAS EN INSTALADOR DE REDES DE TELECOMUNICACIONES": "TC LAB COMPT INSTALD RED COMU",
    "T√âCNICO LABORAL EN FORMACI√ìN PREESCOLAR Y RECREACI√ìN INFANTIL": "TC LAB FORM PREESC RECRE INFAN",
    "Especializaci√≥n en Desarollo integral de la infancia y la adolescencia": "ESP DESAR INTGRL INFA Y ADOLES",
    "ESPECIALIZACI√ìN EN APLICACI√ìN DE TIC PARA LA ENSE√ëANZA": "ESP APLICA TIC PARA LA ENSE√ëAN",
    "PRESELECCION DE TALENTO HUMANO MEDIADO POR HERRAMIENTAS TIC": "PRESELEC TALTO HUM HERRA TIC",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILIAR EN SEGURIDAD OCUPACIONAL": "TC LAB COMPT AUX SEG OCUPACI",
    "T√âCNICO LABORAL POR COMPETENCIAS AUXILIAR EN SISTEMAS": "TC LAB COMPT AUX EN SISTEMAS",
    "T√âCNICO LABORAL AUXILIAR DE EDUCACI√ìN PARA LA PRIMERA INFANCIA": "TC LAB AUX EDUC PRIMER INFAN",
    "M√°ster Universitario en Educaci√≥n Inclusiva e Intercultural.": "MA UNIVER EDUC INCLUS INTERC",
    "T√âCNICO EN DISE√ëO E INTEGRACION MULTIMEDIA": "TC DISE√ëO INTEGR MULTIMEDIA",
    "T√âCNICO EN CONTABILIZACI√ìN DE OPERaciones COMERCIALES Y FINANCIERAS": "TC CONTA OPERAC COMER FINA",
    "TECNOLOG√çA EN MANTENIMIENTO DE SISTEMAS ELECTROMEC√ÅNICOS": "TG MANTMTO SISTE ELECTRMECA",
    "TECN√ìLOG√çA EN GESTION DE LA SEGURIDAD Y SALUD EN EL TRABAJO": "TG GSTON SEGURD Y SALUD TRABAJ",
    "T√©cnico Laboral en Manejo y Aplicaci√≥n de Sistemas Inform√°ticos y Bases de Datos": "TC LAB MAN APLIC SISTE INF BAS",
    "TECNICO LABORAL EN ATENCION INTEGRAL A LA PRIMERA INFANCIA": "TC LAB ATNCION INTGRL PRIM INF",
    "TECN√ìLOGIA EN CONTROL DE BIOPROCESOS INDUSTRIALES": "TG CTRL DE BIOPROCES INDUSTRI",
    "TECNICO LABORAL POR COMPETENCIAS EN AUXILIAR DE ENFERMERIA": "TC LAB COMPT AUX DE ENFERMER",
    "ESPECIALIZACION EN PEDAGOGIA AMBIENTAL A DISTANCIA": "ESP PEDAGOGIA AMB A DISTANC",
    "T√âCNICO LABORAL POR COMPETENCIAS EN ASISTENTE SOCIAL Y COMUNITARIO CON √âNFASIS EN ATENCI√ìN A LA PRIMERA": "TC LAB COMPT ASIS SOC COMUN",
    "T√âCNICO LABORAL POR COMPETENCIAS AUXILIAR EN ENFERMERIA": "TC LAB COMPT AUX EN ENFERME",
    "T√âCNICO EN VENTAS DE PRODUCTOS Y SERVICIOS": "TC VENTAS PRODUCT Y SERVIC",
    "TECNICO LABORAL POR COMPETENCIAS EN INSTALACIONES EL√âCTRICAS": "TC LAB COMPT INSTALAC ELECTR",
    "T√âCNICO EN INSTALACION DE SISTEMAS ELECTRICOS RESIDENCIALES Y COMERCIALES": "TC INSTALC SISTE ELECT RESID",
    "TECN√ìLOGO EN PROCESOS PARA LA COMERCIALIZACION INTERNACIONAL": "TG PROCES COMERCI INTERNA",
    "T√âCNICO EN MANTENIMIENTO EL√âCTRICO Y CONTROL ELECTR√ìNICO EN AUTOMOTORES": "TC MANTMTO ELECTR AUTOMO",
    "TECNICA PROFESIONAL EN SOPORTE DE SISTEMAS EN INFORM√ÅTICA": "TC PROFE SOPORT SISTE INFOR",
    "TECN√ìLOGO EN GESTION FINANCIERA Y DE TESORERIA": "TG GSTON FINANC Y TESORERIA",
    "TECNICO LABORAL POR COMPETENCIAS EN ASISTENTE DE PREESCOLAR": "TC LAB COMPT ASISTE PREESCOL",
    "T√âCNICO PROFESional EN ATENCI√ìN A LA PRIMERA INFANCIA": "TC PROFESI ATNCON PRIMER INFA",
    "Tecnologia en Gesti√≥n de Recursos Naturales": "TG GSTON RECURSOS NATURALES",
    "TECNOLOG√çA EN OPERACI√ìN DE PLANTAS PETROQU√çMICAS": "TG OPERACI√ìN PLNTS PETROQUIM",
    "TECNOLOGO EN ADMINISTRACI√ìN EN SERVICIOS DE SALUD": "TG ADMON SERVICIOS DE SALUD",
    "T√âCNICO LABORAL EN AUXILIAR EN EDUCACI√ìN PARA LA PRIMERA INFANCIA": "TC LAB AUX EDUC PRIMER INFAN",
    "T√âCNICO LABORAL POR COMPETENCIAS FORMACI√ìN Y ATENCI√ìN A LA PRIMERA INFANCIA": "TC LAB COMPT FORM ATNC PRIM",
    "TECNOLOGIA EN GESTION DE ANALITICA Y BIG DATA": "TG GSTON ANALITICA Y BIG DATA",
    "TECNOLOGIA EN GESTION CONTABLE Y FINANCIERA VIRTUAL": "TG GSTON CONTBLE Y FINAN VIR",
    "T√©cnico en el Riesgo Crediticio y su Administraci√≥n": "TC RIESGO CREDIT Y SU ADMON",
    "T√âCNICO PROFESIONAL EN SERVICIO DE POLICIA ESECU": "TC PROFES SERV POLIC ESECU",
    "T√âCNICO EN CONSERVACION DE RECURSOS NATURALES": "TC EN CONSERV RECURS NATURAL",
    "TECNOLOG√çA EN PREVENCI√ìN Y CONTROL AMBIENTAL": "TG PREVENCION Y CTRL AMBIENTAL",
    "PROGRAMA T√âCNICO PROFESIONAL DISE√ëO WEB Y MULTIMEDIA": "TC PROFES DISE√ë WEB Y MULTIMED",
    "TECNOLOG√çA GESTI√ìN DE EMPRESas AGROPECUARIAS": "TG GSTON EMPRESAS AGROPECUAR",
    "TECN√ìLOGO EN GESTI√ìN DE LA SEGURIDAD Y SALUD EN EL TRABAJO": "TG GSTON SEGUR Y SALUD TRABAJO",
    "TECNOLOGO EN AN√ÅLISIS Y DESARROLLO DE SOFTWARE": "TG ANALISIS Y DESARRO DE SOFTW",
    "TECNICO EN ASESORIA COMERCIAL Y OPERACIONES DE ENTIDADES FINANCIERAS": "TC EN ASERIA COMR OPER ENT FIN",
    "T√âCNICO LABORAL POR COMPETENCIAS EN ATENCION INTEGRAL A LA PRIMERA INFANCIA": "TC COMP ATNCN INTGRL PRIM INFA",
    "TECNOLOGO EN SUPERVISI√ìN DE REDES DE DISTRIBUCI√ìN DE ENERG√çA EL√âCTRICA": "TG SUPERV RED DISTR ENER ELECT",
    "T√âCNICA PROFESIONAL EN SOPORTE DE SISTEMAS EN INFORMATIC": "TC PROFES SOPORT SISTE INFORMA",
    "T√âCNICO EN ASESOR√çA COMERCIAL Y OPERACIONES DE ENTIDADES FINANCIERA": "TC EN ASERIA COMR OPER ENT FIN",
    "ESPECIALISTA EN ATENCION INTEGRAL A la PRIMERA INFANCIA": "ESP ATNCION INTGRL PRIME INFA",
    "TECNICO LABORAL POR COMPETENCIAS AUXILIAR EN SEGURIDAD OCUPACIONAL Y LABORAL": "TC LAB COMP SEGU OCUP Y LAB",
    "Especializaci√≥n en Pedagog√≠a de la L√∫dica para el desarrollo cultural": "ESP PEDAGO LUD DESARR CULTURAL",
    "TECNOLOGO EN GESTION DE LA SEGURIDAD Y SALUD EN EL TRABAJO": "TG GSTON SEGU Y SALUD TRABAJO",
    "ESP GERENCIA FINANCIERAV VIR": "ESP GERENCIA FINANCIERAV VIR",
    "ESPECIALIZACI√ìN EN DESAROLLO INTEGRAL DE LA INFANCIA Y LA ADOLESCENCIA - EDIIA": "ESP DESAR INTGRL INFA Y ADOLES",
    "tecnologo en analisis y desarrollo de software": "TG ANALISIS Y DESARROLLO SOFTW",
    "tecnologo en gestion contable y de informacion financiera": "TG GSTON CONTABL Y INFO FINANC"
}


mensajes_resumen_procesamiento = []
unprocessed_files_paths = [] 
processed_data_cache = [] 
active_api_key_index = 1
active_openrouter_key_index = 1
thread_lock = threading.Lock()

class RateLimitException(Exception):
    pass
class ServerSideApiException(Exception):
    pass

def normalizar_texto_para_busqueda(texto):
    if not isinstance(texto, str): return ""
    return texto.lower().strip().replace('.', '')

ABREVIATURAS_NORMALIZADAS = {normalizar_texto_para_busqueda(k): v for k, v in ABREVIATURAS_PREDEFINIDAS.items()}

def quitar_tildes(texto):
    if not isinstance(texto, str): return texto
    nfkd_form = unicodedata.normalize('NFD', texto)
    return "".join([c for c in nfkd_form if not unicodedata.combining(c)])

def _intentar_extraccion_llmwhisperer(file_path, api_key, key_number):
    nombre_base = os.path.basename(file_path)
    print(f"Inicializando cliente LLMWhisperer para PDF '{nombre_base}' con API Key #{key_number}...")
    client = LLMWhispererClientV2(api_key=api_key)
    print(f"Enviando PDF '{file_path}' a LLMWhisperer (Key #{key_number})...")
    resultado = client.whisper(file_path=file_path, wait_for_completion=True, wait_timeout=360)
    print(f"\n‚úÖ Resultado del an√°lisis de LLMWhisperer obtenido para PDF '{nombre_base}'.")
    if isinstance(resultado, dict) and 'extraction' in resultado and isinstance(resultado['extraction'], dict) and 'result_text' in resultado['extraction']:
        return resultado['extraction']['result_text'].replace("<<<\x0c", "\n--- NUEVA P√ÅGINA --- \n")
    else:
        msg = f"‚ùå Error LLMWhisperer PDF '{nombre_base}': No se encontr√≥ 'extraction' o 'result_text'."
        print(msg)
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg)
        return None

def extraer_texto_pdf_con_apis(file_path):
    global mensajes_resumen_procesamiento, active_api_key_index
    with thread_lock:
        current_api_key_index = active_api_key_index

    if current_api_key_index == 1:
        current_key, current_key_num = LLMWHISPERER_API_KEY_1, 1
    else:
        current_key, current_key_num = LLMWHISPERER_API_KEY_2, 2
        print(f"INFO: Usando directamente la API Key de respaldo #{current_key_num}...")
    try:
        return _intentar_extraccion_llmwhisperer(file_path, current_key, current_key_num)
    except LLMWhispererClientException as e:
        msg_error_api = str(e).lower()
        codigo_estado_api = e.status_code if hasattr(e, 'status_code') else 0
        if (codigo_estado_api == 402 or "breached your free processing limit" in msg_error_api):
            if current_api_key_index == 1:
                print(f"‚ö†Ô∏è L√çMITE ALCANZADO en API Key #1. Cambiando a API Key #2 para '{os.path.basename(file_path)}' y subsiguientes.")
                with thread_lock:
                    mensajes_resumen_procesamiento.append(f"‚ö†Ô∏è L√çMITE API Unstract #1. Cambiando a API #2.")
                    globals()['active_api_key_index'] = 2
                try:
                    return _intentar_extraccion_llmwhisperer(file_path, LLMWHISPERER_API_KEY_2, 2)
                except Exception as e2:
                    msg = f"‚ùå Fallo en el reintento con API Key #2 para '{os.path.basename(file_path)}': {e2}"
                    print(msg)
                    traceback.print_exc()
                    with thread_lock:
                        mensajes_resumen_procesamiento.append(msg + f"\n{traceback.format_exc()}")
                    return None
            else: # current_api_key_index == 2
                msg = f"‚ùå L√çMITE ALCANZADO tambi√©n en API Key #2. No hay m√°s claves disponibles."
                print(msg)
                with thread_lock:
                    mensajes_resumen_procesamiento.append(msg)
                return None
        else:
            msg = f"‚ùå Error con LLMWhisperer para PDF '{os.path.basename(file_path)}': {e} (C√≥digo: {codigo_estado_api})"
            print(msg)
            with thread_lock:
                mensajes_resumen_procesamiento.append(msg)
            return None
    except Exception as e:
        msg = f"‚ùå Error inesperado durante el an√°lisis con LLMWhisperer para PDF '{os.path.basename(file_path)}': {e}"
        print(msg)
        traceback.print_exc()
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg + f"\n{traceback.format_exc()}")
        return None

def extraer_texto_excel_con_pandas(file_path):
    global mensajes_resumen_procesamiento
    nombre_base = os.path.basename(file_path)
    print(f"Procesando archivo Excel '{nombre_base}' con pandas...")
    try:
        xls = pd.ExcelFile(file_path)
        full_text_parts = []
        if not xls.sheet_names:
            msg = f"‚ö†Ô∏è El archivo Excel '{nombre_base}' no contiene hojas."
            print(msg)
            with thread_lock:
                mensajes_resumen_procesamiento.append(msg)
            return ""
        for sheet_name in xls.sheet_names:
            df = xls.parse(sheet_name, header=None, dtype=str).fillna('')
            full_text_parts.append(f"--- INICIO HOJA: {sheet_name} ---\n")
            full_text_parts.extend(" | ".join(str(cell).strip() for cell in row) for index, row in df.iterrows())
            full_text_parts.append(f"\n--- FIN HOJA: {sheet_name} ---\n")
        print(f"‚úÖ Texto extra√≠do del archivo Excel '{nombre_base}'.")
        return "\n".join(full_text_parts)
    except Exception as e:
        msg = f"‚ùå Error al procesar Excel '{nombre_base}' con pandas: {e}"
        print(msg)
        traceback.print_exc()
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg + f"\n{traceback.format_exc()}")
        return None

def limpiar_texto_general_para_llm(texto):
    if not texto: return ""
    return re.sub(r'\n{3,}', '\n', texto).strip()

def analizar_con_llm(texto_documento, pregunta_o_instruccion, model_name, api_url, nombre_archivo_base, force_api_key_num=None):
    global mensajes_resumen_procesamiento, active_openrouter_key_index

    with thread_lock:
        current_api_key_num = force_api_key_num if force_api_key_num else active_openrouter_key_index
        if current_api_key_num == 1:
            api_token = OPENROUTER_API_KEY
        elif current_api_key_num == 2 and OPENROUTER_API_KEY_2:
            api_token = OPENROUTER_API_KEY_2
        else:
            msg = f"‚ùå No hay una clave de API de OpenRouter v√°lida (intentando usar la #{current_api_key_num}) para '{nombre_archivo_base}'."
            print(msg)
            mensajes_resumen_procesamiento.append(msg)
            return None

    print(f"\nPreparando para enviar a OpenRouter para '{nombre_archivo_base}' usando modelo '{model_name}' (API Key #{current_api_key_num})...")
    prompt_completo = f"Aqu√≠ tienes el contenido de un documento (originalmente '{nombre_archivo_base}'):\n--- INICIO DEL DOCUMENTO ---\n{texto_documento}\n--- FIN DEL DOCUMENTO ---\nPor favor, sigue estas instrucciones detalladamente basadas √öNICAMENTE en el documento proporcionado:\n{pregunta_o_instruccion}"

    headers = {
        "Authorization": f"Bearer {api_token}", "Content-Type": "application/json",
        "HTTP-Referer": YOUR_SITE_URL, "X-Title": YOUR_SITE_NAME
    }
    data = {
        "model": model_name, "messages": [{"role": "user", "content": prompt_completo}],
        "stream": False, "max_tokens": 4000, "temperature": 0.15
    }

    try:
        print(f"Enviando solicitud a OpenRouter (modelo: {model_name}, Key #{current_api_key_num}) para '{nombre_archivo_base}'...")
        response = requests.post(api_url, headers=headers, data=json.dumps(data), timeout=360)
        response.raise_for_status()
        respuesta_json = response.json()
        print(f"‚úÖ Respuesta recibida de OpenRouter API para '{nombre_archivo_base}'.")
        if respuesta_json.get("choices") and len(respuesta_json["choices"]) > 0 and respuesta_json["choices"][0].get("message") and "content" in respuesta_json["choices"][0]["message"]:
            return respuesta_json["choices"][0]["message"]["content"]
        else:
            msg = f"‚ùå Error API OpenRouter '{nombre_archivo_base}': Respuesta sin formato esperado."
            print(msg)
            with thread_lock:
                mensajes_resumen_procesamiento.append(msg)
            return None
    except requests.exceptions.Timeout as e:
        msg = f"‚ùå Error API OpenRouter '{nombre_archivo_base}': Timeout."
        print(msg)
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg)
        raise ServerSideApiException(msg) from e
    except requests.exceptions.RequestException as e:
        status_code = e.response.status_code if e.response is not None else 0
        details = f"Detalles: {status_code} - {e.response.text}" if e.response is not None else ""
        msg = f"‚ùå Error API OpenRouter '{nombre_archivo_base}' (Modelo: {model_name}, Key: #{current_api_key_num}): {e}"
        
        print(msg)
        print(details)
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg + "\n" + details)
        
        if status_code == 429:
            raise RateLimitException(msg) from e
        if 500 <= status_code < 600:
            raise ServerSideApiException(msg) from e
        return None
    except Exception as e:
        msg = f"‚ùå Error inesperado con OpenRouter API para '{nombre_archivo_base}': {e}"
        print(msg)
        traceback.print_exc()
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg + f"\n{traceback.format_exc()}")
        return None

def analizar_con_gemini(texto_documento, pregunta_o_instruccion, nombre_archivo_base):
    global mensajes_resumen_procesamiento
    if not GEMINI_API_KEY:
        msg = f"‚ùå API de Gemini no configurada para '{nombre_archivo_base}'. Fallback no disponible."
        print(msg)
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg)
        return None

    print(f"\n‚ö°Ô∏è Intentando con Google Gemini para '{nombre_archivo_base}'...")
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        safety_settings = [
            {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
        ]
        generation_config = {"temperature": 0.15, "max_output_tokens": 4000}
        model = genai.GenerativeModel(
            model_name="gemini-1.5-pro-latest", generation_config=generation_config, safety_settings=safety_settings
        )
        prompt_completo = f"Aqu√≠ tienes el contenido de un documento (originalmente '{nombre_archivo_base}'):\n--- INICIO DEL DOCUMENTO ---\n{texto_documento}\n--- FIN DEL DOCUMENTO ---\nPor favor, sigue estas instrucciones detalladamente basadas √öNICAMENTE en el documento proporcionado:\n{pregunta_o_instruccion}"
        response = model.generate_content(prompt_completo)
        
        if not response.parts:
            block_reason = response.prompt_feedback.block_reason if response.prompt_feedback else "No especificada"
            msg = f"‚ùå La respuesta de Gemini para '{nombre_archivo_base}' fue bloqueada. Raz√≥n: {block_reason}"
            print(msg)
            with thread_lock:
                mensajes_resumen_procesamiento.append(msg)
            return None

        print(f"‚úÖ Respuesta recibida de Google Gemini API para '{nombre_archivo_base}'.")
        return response.text
    except Exception as e:
        msg = f"‚ùå Error fatal durante el an√°lisis con Google Gemini para '{nombre_archivo_base}': {e}"
        print(msg)
        traceback.print_exc()
        with thread_lock:
            mensajes_resumen_procesamiento.append(msg + f"\n{traceback.format_exc()}")
        return None


def extraer_datos_completos(respuesta_llm):
    def limpiar_valor(texto): return texto.strip().strip('*').strip()
    
    datos = {
        "Nombre": "No extra√≠do", "Programa": "No extra√≠do", "Plan": "N/A",
        "Programa Origen": "No extra√≠do", "Abreviacion Sugerida": "ABREV_NO_PROPORCIONADA",
        "Creditos": "0", "Script Template": None
    }
    if not respuesta_llm: return datos

    match_nombre = re.search(r"NOMBRE_ESTUDIANTE:\s*(.*)", respuesta_llm)
    if match_nombre: datos["Nombre"] = limpiar_valor(match_nombre.group(1).splitlines()[0])
    
    match_programa = re.search(r"PROGRAMA_ASPIRA:\s*(.*)", respuesta_llm)
    if match_programa: datos["Programa"] = limpiar_valor(match_programa.group(1).splitlines()[0])

    match_plan = re.search(r"PLAN_ESTUDIO:\s*(.*)", respuesta_llm)
    if match_plan: datos["Plan"] = limpiar_valor(match_plan.group(1).strip().splitlines()[0]) or "N/A"

    match_origen = re.search(r"NOMBRE_PROGRAMA_ORIGEN:\s*(.*)", respuesta_llm)
    if match_origen: datos["Programa Origen"] = limpiar_valor(match_origen.group(1).strip().splitlines()[0])
    
    match_abrev = re.search(r"ABREVIACION_SUGERIDA:\s*(.*)", respuesta_llm)
    if match_abrev: datos["Abreviacion Sugerida"] = limpiar_valor(match_abrev.group(1).strip().splitlines()[0])

    match_creditos = re.search(r"CREDITOS_HOMOLOGADOS:\s*(.*)", respuesta_llm)
    if match_creditos:
        creditos_str = limpiar_valor(match_creditos.group(1).strip().splitlines()[0])
        datos["Creditos"] = creditos_str if creditos_str.isdigit() else "0"

    match_script = re.search(r"--- INICIO SCRIPT AUTOHOTKEY ---(.*?)--- FIN SCRIPT AUTOHOTKEY ---", respuesta_llm, re.DOTALL)
    if match_script:
        datos["Script Template"] = match_script.group(1).strip()
    return datos

def sanitizar_nombre_archivo(nombre):
    nombre_sanitizado = re.sub(r'[<>:"/\\|?*]', '', nombre).replace("\n", " ").replace("\r", " ").strip()
    return re.sub(r'\s+', ' ', nombre_sanitizado) or "ScriptSinNombreValido"

def save_unprocessed_files(files_to_save, parent_window):
    if not files_to_save:
        messagebox.showinfo("Informaci√≥n", "No hay archivos no procesados para guardar.", parent=parent_window)
        return

    dest_folder = filedialog.askdirectory(title="Seleccione una carpeta para guardar los archivos no procesados")
    if not dest_folder:
        return 

    file_paths = [item['path'] for item in files_to_save]
    copied_count = 0
    errors = []
    for file_path in file_paths:
        try:
            shutil.copy(file_path, dest_folder)
            copied_count += 1
        except Exception as e:
            errors.append(f"No se pudo copiar '{os.path.basename(file_path)}': {e}")
    
    summary_message = f"{copied_count} de {len(file_paths)} archivos guardados exitosamente en:\n{dest_folder}"
    if errors:
        summary_message += "\n\nOcurrieron los siguientes errores:\n" + "\n".join(errors)
        messagebox.showerror("Error al Guardar", summary_message, parent=parent_window)
    else:
        messagebox.showinfo("Proceso Completado", summary_message, parent=parent_window)

def guardar_resultados_csv(datos_a_guardar, directorio_salida, ventana_padre):
    if not datos_a_guardar:
        print("No hay datos en cach√© para guardar en el archivo de resultados.")
        return

    try:
        directorio_logs = os.path.join(directorio_salida, "LOGS")
        if not os.path.exists(directorio_logs):
            print(f"La carpeta 'LOGS' no existe. Cre√°ndola en: {directorio_logs}")
            os.makedirs(directorio_logs)
        else:
            print(f"La carpeta 'LOGS' ya existe.")

        timestamp = time.strftime("%Y-%m-%d_%H-%M-%S")
        nombre_archivo = f"Resultados_Procesamiento_{timestamp}.csv"
        ruta_completa_salida = os.path.join(directorio_logs, nombre_archivo)
        datos_para_df = [dict(row) for row in datos_a_guardar]
        
        for row in datos_para_df:
            row.pop("Script Template", None)
            row.pop("Ruta Completa", None)
            row.pop("Abreviacion Sugerida", None)
            row.pop("Ruta AHK", None)

        df = pd.DataFrame(datos_para_df)
        
        column_map = {
            "Archivo Origen": "Archivo Origen",
            "Modelo Usado": "Modelo Usado",
            "Programa": "Programa al que aspira",
            "Plan": "Plan",
            "Nivel": "Nivel",
            "Programa Origen": "Programa Origen",
            "Creditos": "Cr√©ditos Homologados"
        }
        
        df_columnas_existentes = [col for col in column_map.keys() if col in df.columns]
        df = df[df_columnas_existentes]
        df.rename(columns=column_map, inplace=True)
        df.to_csv(ruta_completa_salida, index=False, encoding='utf-8-sig')
        
        print(f"‚úÖ Resultados guardados exitosamente en: {ruta_completa_salida}")
        messagebox.showinfo(
            "Resultados Guardados",
            f"Un resumen de los resultados ha sido guardado en:\n\n{ruta_completa_salida}",
            parent=ventana_padre
        )
    except Exception as e:
        print(f"‚ùå Error al guardar el archivo de resultados CSV: {e}")
        traceback.print_exc()
        messagebox.showerror(
            "Error al Guardar Resultados",
            f"No se pudo guardar el archivo de resumen CSV.\n\nError: {e}",
            parent=ventana_padre
        )

def mostrar_resumen_log_gui(main_root_ref, lista_mensajes, unprocessed_list):
    if not lista_mensajes:
        lista_mensajes = ["No se procesaron archivos o no hubo mensajes de resumen."]

    resumen_ventana = tk.Toplevel(main_root_ref)
    resumen_ventana.title("Resumen del Procesamiento (Log)")
    resumen_ventana.geometry("800x600")

    text_frame = ttk.Frame(resumen_ventana)
    text_frame.pack(padx=10, pady=(10, 0), fill=tk.BOTH, expand=True)
    
    txt_area = scrolledtext.ScrolledText(text_frame, wrap=tk.WORD, width=100, height=30)
    txt_area.pack(fill=tk.BOTH, expand=True)

    lista_mensajes_ordenada = sorted(lista_mensajes)
    for msg in lista_mensajes_ordenada:
        txt_area.insert(tk.END, msg + "\n" + "-"*50 + "\n")
    txt_area.config(state=tk.DISABLED)

    button_frame = ttk.Frame(resumen_ventana)
    button_frame.pack(pady=10, fill=tk.X, padx=10)

    save_button = ttk.Button(
        button_frame, 
        text=f"Guardar {len(unprocessed_list)} Archivos No Procesados",
        command=lambda: save_unprocessed_files(unprocessed_list, resumen_ventana)
    )
    save_button.pack(side=tk.LEFT, padx=(0, 10), expand=True, fill=tk.X)
    if not unprocessed_list:
        save_button.config(state=tk.DISABLED)
    
    close_button = ttk.Button(button_frame, text="Cerrar Log", command=resumen_ventana.destroy)
    close_button.pack(side=tk.RIGHT, expand=True, fill=tk.X)

    resumen_ventana.transient(main_root_ref)
    resumen_ventana.grab_set()

def actualizar_fila_en_tabla(ventana_principal, tabla_treeview, datos_fila):
    def actualizar():
        fila_id = datos_fila["Ruta Completa"]

        with thread_lock:
            ruta_a_buscar = datos_fila["Ruta Completa"]
            processed_data_cache[:] = [d for d in processed_data_cache if d.get("Ruta Completa") != ruta_a_buscar]
            processed_data_cache.append(datos_fila)

        if not tabla_treeview.exists(fila_id):
            print(f"ADVERTENCIA: Se intent√≥ actualizar la fila para '{os.path.basename(fila_id)}' pero no se encontr√≥.")
            return

        programa_original = datos_fila.get("Programa", "N/A")
        programa_normalizado = programa_original.lower().strip()
        tag_color = 'verde' if programa_normalizado in PROGRAMAS_VERDES else 'naranja'
        programa_con_indicador = f"{programa_original.strip()} ‚óè"
        nivel_estudio = datos_fila.get("Nivel", "Pregrado")
        
        nuevos_valores = (
            datos_fila.get("Archivo Origen", "N/A"),
            datos_fila.get("Modelo Usado", "Procesando..."),
            programa_con_indicador if programa_original != "N/A" else "N/A",
            datos_fila.get("Plan", "N/A"),
            nivel_estudio,
            "üìÇ Ver Archivo",
            datos_fila.get("Nombre", ""), 
            "‚úì Realizada", 
            "‚è∏ Pendiente"
        )
        nuevas_etiquetas = ('accion', datos_fila.get("Ruta Completa", ""), tag_color)
        
        tabla_treeview.item(fila_id, values=nuevos_valores, tags=nuevas_etiquetas)

    ventana_principal.after(0, actualizar)

def crear_tabla_resumen_en_vivo(main_root_ref, retry_callback):
    tabla_ventana = tk.Toplevel(main_root_ref)
    tabla_ventana.title("Tabla Resumen de Archivos Procesados (En Vivo)")
    tabla_ventana.geometry("1770x500") 
    
    main_frame = ttk.Frame(tabla_ventana, padding="10")
    main_frame.pack(fill=tk.BOTH, expand=True)

    tree_frame = ttk.Frame(main_frame)
    tree_frame.pack(fill=tk.BOTH, expand=True)
    
    cols = ("Archivo Origen", "Modelo Usado", "Programa al que aspira", "Plan", "Nivel", "Acciones", "Ejecutar Script", "Marcar Realizada", "Marcar Pendiente")
    
    style = ttk.Style()
    
    style.element_create("Custom.Treeheading.border", "from", "default")
    style.layout("Custom.Treeview", [
        ('Custom.Treeview.treearea', {'sticky': 'nswe'})
    ])
    
    style.configure("Custom.Treeview", 
                   rowheight=30, 
                   font=("Segoe UI", 9),
                   fieldbackground="white")
    style.configure("Custom.Treeview.Heading", font=("Segoe UI", 10, "bold"))
    
    style.map('Custom.Treeview',
        background=[], 
        foreground=[]
    )
    
    tree = ttk.Treeview(tree_frame, columns=cols, show='headings', style="Custom.Treeview")
    
    def on_select(event):
        pass
    
    tree.bind('<<TreeviewSelect>>', on_select)

    def sort_by_column(tv, col, reverse):
        l = [(tv.set(k, col), k) for k in tv.get_children('')]
        l.sort(reverse=reverse)
        for index, (val, k) in enumerate(l):
            tv.move(k, '', index)
        tv.heading(col, command=lambda: sort_by_column(tv, col, not reverse))

    for col in cols:
        tree.heading(col, text=col, command=lambda _col=col: sort_by_column(tree, _col, False))
        if col == "Acciones": tree.column(col, width=120, minwidth=100, anchor='center')
        elif col == "Plan": tree.column(col, width=100, minwidth=80, anchor='center')
        elif col == "Nivel": tree.column(col, width=100, minwidth=80, anchor='center')
        elif col == "Programa al que aspira": tree.column(col, width=250, minwidth=200, anchor='w')
        elif col == "Modelo Usado": tree.column(col, width=150, minwidth=120, anchor='w')
        elif col == "Ejecutar Script": tree.column(col, width=150, minwidth=130, anchor='center')
        elif col == "Marcar Realizada": tree.column(col, width=150, minwidth=130, anchor='center')
        elif col == "Marcar Pendiente": tree.column(col, width=150, minwidth=130, anchor='center')
        else: tree.column(col, width=200, minwidth=150, anchor='w')

    tree.tag_configure('verde', background='#D5F5E3')
    tree.tag_configure('naranja', background='#FAE5D3')
    tree.tag_configure('accion', background="#E3F2FD", font=("Segoe UI", 9, "bold"))
    tree.tag_configure('ejecutar', background="#4CAF50", foreground="white", font=("Segoe UI", 9, "bold"))
    tree.tag_configure('pendiente', background="#FFA726", foreground="white", font=("Segoe UI", 9, "bold"))
    tree.tag_configure('realizada', background="#2196F3", foreground="white", font=("Segoe UI", 9, "bold"))
    
    vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=tree.yview)
    vsb.pack(side='right', fill='y')
    tree.configure(yscrollcommand=vsb.set)
    hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=tree.xview)
    hsb.pack(side='bottom', fill='x')
    tree.configure(xscrollcommand=hsb.set)
    tree.pack(fill=tk.BOTH, expand=True)

    button_frame = ttk.Frame(main_frame)
    button_frame.pack(fill=tk.X, pady=(10, 0))

    retry_button = ttk.Button(
        button_frame,
        text="Reintentar Archivos Fallidos",
        command=retry_callback,
        state=tk.DISABLED
    )
    retry_button.pack(side=tk.RIGHT, padx=5)

    def on_click(event):
        if tree.identify_region(event.x, event.y) != "cell": return
        
        column_id_str = tree.identify_column(event.x)
        row_id = tree.identify_row(event.y)
        if not row_id: return
        
        if column_id_str == '#6': 
            if os.path.exists(row_id):
                try:
                    if os.name == 'nt': os.startfile(row_id)
                    elif os.name == 'posix': subprocess.run(['xdg-open', row_id], check=True)
                    else: subprocess.run(['open', row_id], check=True)
                except Exception as e:
                    messagebox.showerror("Error", f"No se pudo abrir el archivo original:\n{e}", parent=tabla_ventana)
            else:
                messagebox.showwarning("Archivo no encontrado", f"No se encontr√≥ el archivo original:\n{row_id}", parent=tabla_ventana)
        
        elif column_id_str == '#7':
            with thread_lock:
                datos_del_archivo = next((item for item in processed_data_cache if item.get("Ruta Completa") == row_id), None)
            
            if datos_del_archivo:
                ruta_ahk = datos_del_archivo.get("Ruta AHK")
                if ruta_ahk and os.path.exists(ruta_ahk):
                    try:
                        if os.name == 'nt':
                            os.startfile(ruta_ahk)
                        else:
                            messagebox.showinfo("Informaci√≥n", "La ejecuci√≥n de scripts AHK solo es compatible con Windows.", parent=tabla_ventana)
                    except Exception as e:
                        messagebox.showerror("Error", f"No se pudo ejecutar el script AHK:\n{e}", parent=tabla_ventana)
                else:
                    messagebox.showwarning("Script no Encontrado", "No se encontr√≥ un script AHK para este archivo.", parent=tabla_ventana)
            else:
                messagebox.showwarning("Datos no encontrados", "No se encontraron datos de procesamiento para este archivo.", parent=tabla_ventana)

        elif column_id_str == '#8':
            with thread_lock:
                datos_del_archivo = next((item for item in processed_data_cache if item.get("Ruta Completa") == row_id), None)

            if not datos_del_archivo:
                messagebox.showwarning("Datos no encontrados", "No se encontraron datos de procesamiento para este archivo.", parent=tabla_ventana)
                return

            pdf_path = datos_del_archivo.get("Ruta Completa")
            ahk_path = datos_del_archivo.get("Ruta AHK")
            
            if not pdf_path or not os.path.exists(pdf_path):
                messagebox.showerror("Error", "No se encontr√≥ la ruta del archivo PDF original.", parent=tabla_ventana)
                return
            
            base_dir = os.path.dirname(pdf_path)
            realizadas_dir = os.path.join(base_dir, "REALIZADAS")
            scripts_dir = os.path.join(base_dir, "EXCEL Y SCRIPTS")
            
            try:
                os.makedirs(realizadas_dir, exist_ok=True)
                os.makedirs(scripts_dir, exist_ok=True)

                shutil.move(pdf_path, realizadas_dir)
                
                if ahk_path and os.path.exists(ahk_path):
                    shutil.move(ahk_path, scripts_dir)
                
                messagebox.showinfo("√âxito", f"Archivos movidos correctamente:\n\nPDF a: {realizadas_dir}\nScript AHK a: {scripts_dir}", parent=tabla_ventana)
                
                tree.delete(row_id)
            except Exception as e:
                messagebox.showerror("Error al Mover", f"Ocurri√≥ un error al mover los archivos:\n{e}", parent=tabla_ventana)

        elif column_id_str == '#9':
            pdf_path = row_id
            if not pdf_path or not os.path.exists(pdf_path):
                messagebox.showerror("Error", "No se encontr√≥ la ruta del archivo PDF original.", parent=tabla_ventana)
                return

            # Obtener partes del nombre
            nombre_archivo_completo = os.path.basename(pdf_path)
            nombre_sin_ext, extension = os.path.splitext(nombre_archivo_completo)

            # --- Crear Ventana de Di√°logo Personalizada ---
            dialogo = tk.Toplevel(tabla_ventana)
            dialogo.title("Mover a Pendientes - Modificar Nombre")
            dialogo.geometry("600x180")
            dialogo.resizable(False, False)
            
            # Hacer la ventana modal (bloquea la de atr√°s hasta cerrar)
            dialogo.transient(tabla_ventana)
            dialogo.grab_set()

            # Contenedor principal
            frame_diag = ttk.Frame(dialogo, padding="20")
            frame_diag.pack(fill=tk.BOTH, expand=True)

            ttk.Label(frame_diag, text="Agregue el detalle al final del nombre:", font=("Segoe UI", 10)).pack(anchor='w', pady=(0, 10))

            # Frame para visualizar la estructura "Nombre - Input"
            frame_nombre = ttk.Frame(frame_diag)
            frame_nombre.pack(fill=tk.X, pady=5)

            # Parte 1: Nombre original (Est√°tico)
            lbl_orig = ttk.Label(frame_nombre, text=nombre_sin_ext, font=("Segoe UI", 9, "bold"))
            lbl_orig.pack(side=tk.LEFT)

            # Parte 2: El gui√≥n separador (Est√°tico)
            lbl_sep = ttk.Label(frame_nombre, text=" - ", font=("Segoe UI", 9, "bold"))
            lbl_sep.pack(side=tk.LEFT)

            # Parte 3: El input del usuario
            entry_sufijo = ttk.Entry(frame_nombre)
            entry_sufijo.pack(side=tk.LEFT, fill=tk.X, expand=True)
            entry_sufijo.focus_set() # Poner el cursor aqu√≠ autom√°ticamente

            ttk.Label(frame_diag, text=f"Extensi√≥n: {extension}", foreground="gray").pack(anchor='w', pady=(2, 10))

            # Funci√≥n interna para ejecutar el movimiento
            def confirmar_accion(event=None):
                texto_agregado = entry_sufijo.get().strip()
                
                # Validar caracteres inv√°lidos en nombres de archivo
                caracteres_invalidos = '<>:"/\\|?*'
                if any(c in caracteres_invalidos for c in texto_agregado):
                    messagebox.showwarning("Nombre inv√°lido", f"El texto no puede contener: {caracteres_invalidos}", parent=dialogo)
                    return

                # Construir nuevo nombre
                if texto_agregado:
                    nuevo_nombre_archivo = f"{nombre_sin_ext} - {texto_agregado}{extension}"
                else:
                    # Si el usuario no escribe nada, confirmamos si quiere moverlo con el nombre original
                    if not messagebox.askyesno("Sin texto", "¬øDesea mover el archivo sin agregar ning√∫n texto adicional?", parent=dialogo):
                        return
                    nuevo_nombre_archivo = nombre_archivo_completo

                base_dir = os.path.dirname(pdf_path)
                pendientes_dir = os.path.join(base_dir, "PENDIENTES")

                try:
                    os.makedirs(pendientes_dir, exist_ok=True)
                    nueva_ruta_completa = os.path.join(pendientes_dir, nuevo_nombre_archivo)

                    # Verificar si ya existe un archivo con ese nombre en destino
                    if os.path.exists(nueva_ruta_completa):
                         messagebox.showerror("Error", f"Ya existe un archivo con este nombre en la carpeta PENDIENTES:\n{nuevo_nombre_archivo}", parent=dialogo)
                         return

                    shutil.move(pdf_path, nueva_ruta_completa)
                    
                    # √âxito: Eliminar de la tabla y cerrar di√°logo
                    tree.delete(row_id)
                    dialogo.destroy()
                    messagebox.showinfo("√âxito", f"Archivo renombrado y movido a:\n{nueva_ruta_completa}", parent=tabla_ventana)
                    
                except Exception as e:
                    messagebox.showerror("Error al Mover", f"Ocurri√≥ un error al mover el archivo:\n{e}", parent=dialogo)

            # Botones Aceptar / Cancelar
            frame_btn = ttk.Frame(frame_diag)
            frame_btn.pack(fill=tk.X, pady=(15, 0))

            btn_cancel = ttk.Button(frame_btn, text="Cancelar", command=dialogo.destroy)
            btn_cancel.pack(side=tk.RIGHT, padx=5)

            btn_ok = ttk.Button(frame_btn, text="Aceptar y Mover", command=confirmar_accion)
            btn_ok.pack(side=tk.RIGHT, padx=5)

            # Permitir presionar ENTER para aceptar
            dialogo.bind('<Return>', confirmar_accion)

    tree.bind("<Button-1>", on_click)

    def editar_con_bloc_notas(ruta_ahk):
        """Abre el archivo AHK con notepad.exe"""
        if not ruta_ahk or not os.path.exists(ruta_ahk):
            messagebox.showerror("Error", "El archivo de script no existe o no se encuentra.", parent=tabla_ventana)
            return
        try:
            # Usamos Popen para que no congele la interfaz mientras el bloc de notas est√° abierto
            subprocess.Popen(["notepad.exe", ruta_ahk])
        except Exception as e:
            messagebox.showerror("Error", f"No se pudo iniciar el Bloc de notas:\n{e}", parent=tabla_ventana)

    def on_right_click(event):
        """Maneja el clic derecho para mostrar el men√∫ de edici√≥n"""
        region = tree.identify_region(event.x, event.y)
        if region != "cell":
            return

        # Identificar columna y fila
        col_id = tree.identify_column(event.x) # '#7' es la columna Ejecutar Script
        row_id = tree.identify_row(event.y)

        if not row_id: 
            return

        # Solo actuar si es la columna #7 (Ejecutar Script)
        if col_id == '#7':
            # Seleccionar visualmente la fila
            tree.selection_set(row_id)
            tree.focus(row_id)

            # Buscar la ruta del AHK en la cach√©
            with thread_lock:
                datos_archivo = next((item for item in processed_data_cache if item.get("Ruta Completa") == row_id), None)

            if datos_archivo and datos_archivo.get("Ruta AHK"):
                ruta_ahk = datos_archivo.get("Ruta AHK")
                
                # Crear men√∫ contextual
                menu_contextual = tk.Menu(tabla_ventana, tearoff=0)
                menu_contextual.add_command(
                    label="‚úèÔ∏è Editar con Bloc de notas", 
                    command=lambda: editar_con_bloc_notas(ruta_ahk)
                )
                
                # Mostrar el men√∫ en la posici√≥n del mouse
                try:
                    menu_contextual.tk_popup(event.x_root, event.y_root)
                finally:
                    menu_contextual.grab_release()
            else:
                # Opcional: Mostrar mensaje si no hay script asociado a√∫n
                pass

    # Vincular el clic derecho (Button-3 en Windows/Linux)
    tree.bind("<Button-3>", on_right_click)
    
    return tree, retry_button

def determinar_nivel_academico(texto_documento):
    texto_lower = texto_documento.lower()
    if any(re.search(r'\b' + p + r'\b', texto_lower) for p in PALABRAS_CLAVE_POSGRADO):
        return "Posgrado"
    else:
        return "Pregrado"

def worker_process_file(archivo_queue, ventana_principal, tabla_treeview, barra_progreso, etiqueta_estado, num_archivos, model_a_usar, worker_id, is_retry=False):
    global mensajes_resumen_procesamiento, unprocessed_files_paths

    while not archivo_queue.empty():
        try:
            queue_item = archivo_queue.get_nowait()
            if is_retry:
                i, archivo_actual, model_a_usar = queue_item
            else:
                i, archivo_actual = queue_item
        except queue.Empty:
            break

        nombre_base_archivo = os.path.basename(archivo_actual)
        ventana_principal.after(0, lambda n=nombre_base_archivo, m=model_a_usar.split('/')[0]: etiqueta_estado.config(text=f"Procesando: {n} (con {m})"))
        mensaje_log_actual = [f"\n--- [Worker #{worker_id} | Modelo: {model_a_usar}] Procesando archivo {nombre_base_archivo} ---"]
        
        texto_extraido = None
        if nombre_base_archivo.lower().endswith('.pdf'):
            texto_extraido = extraer_texto_pdf_con_apis(archivo_actual)
        elif nombre_base_archivo.lower().endswith(('.xlsx', '.xls')):
            texto_extraido = extraer_texto_excel_con_pandas(archivo_actual)

        datos_para_fila_actual = {
            "Archivo Origen": nombre_base_archivo,
            "Ruta Completa": archivo_actual,
            "Modelo Usado": model_a_usar,
            "Ruta AHK": None
        }
        
        is_processed_successfully = False

        if texto_extraido:
            texto_limpio_para_llm = limpiar_texto_general_para_llm(texto_extraido)
            if texto_limpio_para_llm:
                nivel_academico = determinar_nivel_academico(texto_limpio_para_llm)
                datos_para_fila_actual["Nivel"] = nivel_academico
                mensaje_log_actual.append(f"INFO: Nivel acad√©mico clasificado como: {nivel_academico}.")
                prompt_a_usar = PROMPT_ANALISIS_POSTGRADO if nivel_academico == "Posgrado" else PROMPT_ANALISIS_DOCUMENTO
                if nivel_academico == "Posgrado": mensaje_log_actual.append("INFO: Usando prompt especializado para Postgrado.")
                
                respuesta_llm = None
                
                try:
                    time.sleep(1) 
                    mensaje_log_actual.append(f"INFO: Intentando an√°lisis con el modelo asignado: {model_a_usar}.")
                    respuesta_llm = analizar_con_llm(texto_limpio_para_llm, prompt_a_usar, model_a_usar, OPENROUTER_API_URL, nombre_base_archivo)
                except (RateLimitException, ServerSideApiException) as e:
                    mensaje_log_actual.append(f"‚ùå FALLO DE API con el modelo {model_a_usar}: {e}. El archivo no ser√° procesado por este worker.")
                    respuesta_llm = None
                except Exception as e:
                    mensaje_log_actual.append(f"‚ùå ERROR INESPERADO con el modelo {model_a_usar}: {e}")
                    respuesta_llm = None
                
                if respuesta_llm:
                    datos_completos = extraer_datos_completos(respuesta_llm)
                    datos_para_fila_actual.update(datos_completos)
                    
                    if "DETENER_PROCESO_CONDICION_" in respuesta_llm:
                        for line in respuesta_llm.splitlines():
                            if "DETENER_PROCESO_CONDICION_" in line:
                                detalle = line.strip().upper()
                                if "PERIODO" in detalle: datos_para_fila_actual["Plan"] = "DETENIDO: PERIODO"
                                elif "PROGRAMA" in detalle: datos_para_fila_actual["Plan"] = "DETENIDO: PROGRAMA"
                                elif "CALIFICACION" in detalle: datos_para_fila_actual["Plan"] = "DETENIDO: CALIFICACION"
                                else: datos_para_fila_actual["Plan"] = "DETENIDO: OTRO"
                                break
                    else:
                        if datos_completos["Script Template"] and datos_completos.get("Nombre") != "No extra√≠do":
                            programa_origen = datos_completos.get("Programa Origen", "")
                            abreviatura = ""

                            if len(programa_origen) <= 30:
                                abreviatura = programa_origen
                                mensaje_log_actual.append(f"INFO: Abreviatura: Usando nombre de programa de origen original (<=30 caracteres).")
                            else:
                                nombre_origen_norm = normalizar_texto_para_busqueda(programa_origen)
                                if nombre_origen_norm in ABREVIATURAS_NORMALIZADAS:
                                    abreviatura = ABREVIATURAS_NORMALIZADAS[nombre_origen_norm]
                                    mensaje_log_actual.append(f"INFO: Abreviatura: Encontrada en la lista predefinida.")
                                else:
                                    abreviatura = datos_completos["Abreviacion Sugerida"]
                                    mensaje_log_actual.append(f"INFO: Abreviatura: Usando sugerencia del LLM (no encontrada en predefinidas).")
                            
                            abreviatura = quitar_tildes(abreviatura.strip())[:30]
                            encabezado = f"Send, 1{{Tab}}HOM01{{Tab}}HOM01{{Tab}}{datos_completos['Creditos']}{{Tab}}{{Tab}}{{Tab}}{abreviatura}{{F10}}^{{PgDn}}{{Space}}{{Tab}}"
                            script_final = datos_completos["Script Template"].replace('(LINEA_ENCABEZADO_AQUI)', encabezado)
                            
                            nombre_sanitizado = sanitizar_nombre_archivo(datos_completos["Nombre"])
                            ruta_ahk = os.path.join(os.path.dirname(archivo_actual), f"{nombre_sanitizado}.ahk")
                            try:
                                with open(ruta_ahk, "w", encoding="utf-8") as f: f.write(script_final)
                                mensaje_log_actual.append(f"‚úÖ Script AHK guardado en: {ruta_ahk}")
                                datos_para_fila_actual["Ruta AHK"] = ruta_ahk
                                is_processed_successfully = True
                            except Exception as e:
                                mensaje_log_actual.append(f"‚ùå Error guardando AHK: {e}")
                        else:
                            mensaje_log_actual.append(f"‚ùå No se gener√≥ script: faltan datos clave (Nombre/Plantilla).")
                else:
                    mensaje_log_actual.append(f"‚ùå Fall√≥ el API del modelo {model_a_usar}. No se pudo procesar '{nombre_base_archivo}'.")
                    datos_para_fila_actual.update({"Nombre": f"Error en API ({model_a_usar.split('/')[0]})", "Programa": "N/A", "Plan": "N/A"})
            else:
                datos_para_fila_actual.update({"Nombre": "Texto vac√≠o", "Programa": "N/A", "Plan": "N/A"})
        else:
            datos_para_fila_actual.update({"Nombre": "Error Extracci√≥n", "Programa": "N/A", "Plan": "N/A"})

        if not is_processed_successfully:
            with thread_lock:
                failure_info = {
                    "path": archivo_actual,
                    "failed_model": "EXTRACTION_FAILURE" if not texto_extraido else model_a_usar
                }
                if not any(d['path'] == failure_info['path'] for d in unprocessed_files_paths):
                    unprocessed_files_paths.append(failure_info)
        
        actualizar_fila_en_tabla(ventana_principal, tabla_treeview, datos_para_fila_actual)

        with thread_lock:
            mensajes_resumen_procesamiento.extend(mensaje_log_actual)
        archivo_queue.task_done()
        ventana_principal.after(0, barra_progreso.step)

def get_next_model(failed_model, available_models):
    if not available_models:
        return WORKER_MODELS[0]
    try:
        current_index = available_models.index(failed_model)
        next_index = (current_index + 1) % len(available_models)
        return available_models[next_index]
    except ValueError:
        return available_models[0]

def procesar_archivos_seleccionados(lista_archivos, boton_seleccionar, boton_ver_tabla, etiqueta_estado, barra_progreso, etiqueta_etr, ventana_principal, tabla_treeview, retry_button, selected_models, is_retry=False):
    global unprocessed_files_paths, processed_data_cache, original_file_list_for_saving
    
    if not is_retry:
        mensajes_resumen_procesamiento.clear()
        unprocessed_files_paths.clear() 
        processed_data_cache.clear() 
        active_api_key_index = 1
        active_openrouter_key_index = 1
        boton_ver_tabla.config(state=tk.DISABLED)
        original_file_list_for_saving = lista_archivos
    
    num_archivos = len(lista_archivos)
    if barra_progreso:
        barra_progreso['maximum'] = num_archivos
        barra_progreso['value'] = 0
    
    num_modelos_seleccionados = len(selected_models)
    if etiqueta_etr:
        etiqueta_etr.config(text=f"Procesando con {num_modelos_seleccionados} workers seleccionados...")

    def procesar_en_paralelo():
        archivos_queue = queue.Queue()
        if is_retry:
            for item in lista_archivos:
                archivos_queue.put(item)
        else:
            for i, archivo in enumerate(lista_archivos):
                archivos_queue.put((i, archivo))
        
        threads = []
        num_workers_a_usar = min(num_modelos_seleccionados, archivos_queue.qsize())

        for i in range(num_workers_a_usar):
            model_name = selected_models[i % num_modelos_seleccionados]
            thread = threading.Thread(
                target=worker_process_file,
                args=(archivos_queue, ventana_principal, tabla_treeview, barra_progreso, etiqueta_estado, num_archivos, model_name, i + 1, is_retry),
                daemon=True
            )
            threads.append(thread)
            thread.start()

        for t in threads:
            t.join()

        def actualizar_gui_final():
            etiqueta_estado.config(text=f"Procesamiento completado para {num_archivos} archivos.")
            etiqueta_etr.config(text="Proceso finalizado.")
            boton_seleccionar.config(state=tk.NORMAL)
            boton_ver_tabla.config(state=tk.NORMAL)
            
            if unprocessed_files_paths:
                retry_button.config(state=tk.NORMAL)
                messagebox.showwarning("Proceso con Fallos", f"{len(unprocessed_files_paths)} archivo(s) no se procesaron correctamente.\nPuede usar el bot√≥n 'Reintentar Archivos Fallidos' en la ventana de resultados para intentarlo de nuevo.", parent=ventana_principal)
            else:
                retry_button.config(state=tk.DISABLED)

            if original_file_list_for_saving:
                directorio_salida = os.path.dirname(original_file_list_for_saving[0])
                guardar_resultados_csv(processed_data_cache, directorio_salida, ventana_principal)

            mostrar_resumen_log_gui(ventana_principal, mensajes_resumen_procesamiento, unprocessed_files_paths)
            
        ventana_principal.after(0, actualizar_gui_final)

    threading.Thread(target=procesar_en_paralelo, daemon=True).start()

def iniciar_procesamiento_en_hilo(boton_seleccionar, boton_ver_tabla, etiqueta_estado, barra_progreso, etiqueta_etr, ventana_principal, model_vars):
    
    selected_models = [model_name for var, model_name in model_vars if var.get()]

    if not selected_models:
        messagebox.showerror("Sin Modelos", "Debe seleccionar al menos un modelo para procesar.", parent=ventana_principal)
        return
    
    retry_button_ref = None
    tabla_treeview = None 

    def iniciar_reintento():
        global unprocessed_files_paths, mensajes_resumen_procesamiento
        
        selected_models_for_retry = [model_name for var, model_name in model_vars if var.get()]
        if not selected_models_for_retry:
            messagebox.showerror("Sin Modelos", "Debe seleccionar al menos un modelo para el reintento.", parent=ventana_principal)
            return
        
        files_to_retry_info = list(unprocessed_files_paths)
        if not files_to_retry_info:
            messagebox.showinfo("Informaci√≥n", "No hay archivos fallidos para reintentar.", parent=ventana_principal)
            return

        unprocessed_files_paths.clear()
        mensajes_resumen_procesamiento.append("\n" + "="*20 + " INICIANDO REINTENTO " + "="*20 + "\n")
        
        if retry_button_ref: retry_button_ref.config(state=tk.DISABLED)
        boton_seleccionar.config(state=tk.DISABLED)
        
        archivos_para_reintentar = []
        for i, file_info in enumerate(files_to_retry_info):
            path = file_info['path']
            failed_model = file_info['failed_model']
            next_model = get_next_model(failed_model, selected_models_for_retry)
            
            if tabla_treeview and tabla_treeview.exists(path):
                valores_reintento = (os.path.basename(path), "Reintentando...", "...", "...", "...", "Abrir Archivo", "", "(Realizada)", "(Pendiente)")
                tabla_treeview.item(path, values=valores_reintento, tags=('accion', path, ''))
            
            archivos_para_reintentar.append((i, path, next_model))

        procesar_archivos_seleccionados(
            archivos_para_reintentar, boton_seleccionar, boton_ver_tabla, etiqueta_estado, 
            barra_progreso, etiqueta_etr, ventana_principal, tabla_treeview, retry_button_ref, 
            selected_models_for_retry, is_retry=True
        )

    if boton_seleccionar: boton_seleccionar.config(state=tk.DISABLED)
    if etiqueta_estado: etiqueta_estado.config(text="Seleccionando archivos...")
    file_paths = filedialog.askopenfilenames(
        title="Selecciona uno o m√°s archivos PDF o Excel",
        filetypes=(("Documentos Soportados", "*.pdf *.xlsx *.xls"),("Todos los archivos", "*.*"))
    )
    if not file_paths:
        if etiqueta_estado: etiqueta_estado.config(text="Ning√∫n archivo seleccionado.")
        if boton_seleccionar: boton_seleccionar.config(state=tk.NORMAL)
        return
    
    tabla_treeview, retry_button_ref = crear_tabla_resumen_en_vivo(ventana_principal, iniciar_reintento)
    
    try:
        lista_ordenada = sorted(list(file_paths), key=lambda r: os.path.getmtime(r), reverse=False)
        
        for ruta_archivo in lista_ordenada:
            nombre_archivo = os.path.basename(ruta_archivo)
            valores_iniciales = (nombre_archivo, "Pendiente...", "", "", "", "üìÇ Ver Archivo", "", "‚úì Realizada", "‚è∏ Pendiente")
            tags_iniciales = ('accion', ruta_archivo)
            tabla_treeview.insert("", "end", values=valores_iniciales, tags=tags_iniciales, iid=ruta_archivo)
        
        procesar_archivos_seleccionados(
            lista_ordenada, boton_seleccionar, boton_ver_tabla, etiqueta_estado, barra_progreso, 
            etiqueta_etr, ventana_principal, tabla_treeview, retry_button_ref, selected_models, is_retry=False
        )
    except FileNotFoundError as e:
        messagebox.showerror("Error de Archivo", f"No se encontr√≥ el archivo {e.filename}.", parent=ventana_principal)
        if etiqueta_estado: etiqueta_estado.config(text="Error al procesar.")
        if boton_seleccionar: boton_seleccionar.config(state=tk.NORMAL)

def show_last_results_table(main_root_ref):
    if not processed_data_cache:
        messagebox.showinfo("Sin Resultados", "A√∫n no se ha procesado ning√∫n archivo en esta sesi√≥n.", parent=main_root_ref)
        return

    tabla_recreada, _ = crear_tabla_resumen_en_vivo(main_root_ref, lambda: None)
    toplevel_window = tabla_recreada.winfo_toplevel()
    toplevel_window.title("√öltima Tabla de Resultados Guardada")

    for datos_fila in processed_data_cache:
        programa_original = datos_fila.get("Programa", "N/A")
        programa_normalizado = programa_original.lower().strip()
        tag_color = 'verde' if programa_normalizado in PROGRAMAS_VERDES else 'naranja'
        programa_con_indicador = f"{programa_original.strip()} ‚óè"
        
        nivel_estudio = datos_fila.get("Nivel", "Pregrado")
        
        valores = (
            datos_fila.get("Archivo Origen", "N/A"),
            datos_fila.get("Modelo Usado", "N/A"),
            programa_con_indicador,
            datos_fila.get("Plan", "N/A"),
            nivel_estudio,
            "üìÇ Ver Archivo",
            datos_fila.get("Nombre", ""),
            "‚úì Realizada",
            "‚è∏ Pendiente"
        )
        tags_finales = ('accion', datos_fila.get("Ruta Completa", ""), tag_color)
        tabla_recreada.insert("", "end", values=valores, tags=tags_finales, iid=datos_fila.get("Ruta Completa"))

PROMPT_ANALISIS_DOCUMENTO = """Analiza el contenido del documento proporcionado (que ha sido convertido a texto, originado de un PDF o de un archivo Excel) y extrae los datos de c√≥digo y calificaci√≥n para cada una de las materias correspondientes a la secci√≥n: Programa Destino Ibero (que tambi√©n puede llamarse simplemente Programa Destino en algunas ocasiones). Aseg√∫rate de no incluir informaci√≥n de la secci√≥n Programa de Origen.
Igualmente revisa el dato correspondiente al periodo acad√©mico, programa al que aspira, el nombre completo del programa de origen y el n√∫mero correspondiente al total de cr√©ditos homologados.
CONDICIONES DE PARADA:
Revise los siguientes datos del documento: el periodo acad√©mico, el programa al que aspira y las calificaciones del "Programa Destino Ibero". Aplique las siguientes condiciones EN ORDEN. Si CUALQUIERA de estas condiciones se cumple, notif√≠quela claramente indicando la condici√≥n espec√≠fica y la etiqueta de detenci√≥n asociada, y NO contin√∫e con los pasos de "PROCESAMIENTO DE DATOS" ni "FORMATO DE SALIDA".
1.  **Condici√≥n de Periodo Acad√©mico:**
    *   Extraiga el valor del periodo acad√©mico del documento.
    *   **SI** la cadena de texto del periodo acad√©mico extra√≠do **CONTIENE EXACTAMENTE** la secuencia num√©rica "2024" (por ejemplo, "2024-1", "PERIODO 2024B", "202433"), ENTONCES:
        Notifique: "El periodo acad√©mico '{valor_del_periodo_extraido}' contiene '2024'."
        Indique: "DETENER_PROCESO_CONDICION_PERIODO"
        Y detenga todo procesamiento adicional.
    *   DE LO CONTRARIO (si "2024" no est√° presente en el periodo acad√©mico), contin√∫e con la siguiente condici√≥n de parada.
2.  **Condici√≥n de Programa (Maestr√≠a/Especializaci√≥n):**
    *   Extraiga el nombre del programa al que aspira.
    *   **SI** el nombre del programa al que aspira (ignorando may√∫sculas/min√∫sculas) **CONTIENE** alguna de las siguientes palabras: "maestria", "especializacion" o "esp", ENTONCES:
        Notifique: "El programa al que aspira '{nombre_del_programa_extraido}' indica maestr√≠a/especializaci√≥n."
        Indique: "DETENER_PROCESO_CONDICION_PROGRAMA"
        Y detenga todo procesamiento adicional.
    *   DE LO CONTRARIO, contin√∫e con la siguiente condici√≥n de parada.
3.  **Condici√≥n de Calificaciones Bajas o en Blanco:**
    *   Analice las calificaciones de las materias del "Programa Destino Ibero".
    *   **SI** encuentra CUALQUIER materia en el "Programa Destino Ibero" con una calificaci√≥n en blanco (vac√≠a) O con un valor num√©rico inferior a 3.0 (por ejemplo, 2.9, 1.5, 0.0), ENTONCES:
        Notifique: "Se encontr√≥ una calificaci√≥n no v√°lida para la materia '{nombre_materia_con_problema}' con calificaci√≥n '{calificacion_problematica}' en el Programa Destino Ibero."
        Indique: "DETENER_PROCESO_CONDICION_CALIFICACION"
        Y detenga todo procesamiento adicional.
    *   DE LO CONTRARIO, si todas las calificaciones son v√°lidas (3.0 o superior y no en blanco), proceda con los siguientes pasos.
Si NINGUNA de las condiciones de parada anteriores se cumple, Y SOLO EN ESE CASO, proceda con lo siguiente:
PROCESAMIENTO DE DATOS:
Ten en cuenta las siguientes recomendaciones al procesar los datos de las materias del "Programa Destino Ibero":
- Algunos c√≥digos pueden contener espacios; omite estos espacios para obtener solo letras y n√∫meros.
- En los c√≥digos de las materias, los n√∫meros siempre preceden a las letras. Adem√°s, en algunos casos, puede aparecer una letra "F" al final de los n√∫meros; esta letra debe ser omitida.
- Si el c√≥digo de la materia tiene un n√∫mero 0 al final de este debes preservarlo y no eliminarlo.
- Debemos traer al final los c√≥digos tal cual como aparecen en el archivo no debes cambiar los n√∫meros ni las letras de los c√≥digos.
FORMATO DE SALIDA (si no hay condiciones de parada):
1.  **DATOS CLAVE PARA RESUMEN (Presentar antes de la tabla y el script AHK):**
    *   **NOMBRE_ESTUDIANTE:** [Nombre completo del estudiante como aparece en el documento]
    *   **PROGRAMA_ASPIRA:** [Nombre completo del programa al que aspira el estudiante]
    *   **PLAN_ESTUDIO:** [N√∫mero o identificador del plan de estudio asociado al programa al que aspira, si se menciona. Indique "N/A"]
    *   **NOMBRE_PROGRAMA_ORIGEN:** [Nombre completo y exacto del programa de origen extra√≠do del documento]
    *   **CREDITOS_HOMOLOGADOS:** [N√∫mero total de cr√©ditos homologados extra√≠do del documento]
    *   **ABREVIACION_SUGERIDA:** [Genera una abreviatura para el NOMBRE_PROGRAMA_ORIGEN siguiendo las reglas de sustituci√≥n detalladas m√°s abajo. M√°ximo 30 caracteres.]

2.  **TABLA DE DATOS (Materias):**
    Crea una tabla con tres columnas para las materias del "Programa Destino Ibero":
    Primera columna: Contiene solamente las letras de los c√≥digos.
    Segunda columna: Contiene solamente los n√∫meros correspondientes a los c√≥digos.
    Tercera columna: Contiene las calificaciones correspondientes a cada c√≥digo.
    Las calificaciones deben formatearse siempre con un decimal:
    - Si la calificaci√≥n es un n√∫mero entero, debe mostrarse con un decimal (por ejemplo, 4 debe ser 4.0).
    - Si la calificaci√≥n tiene dos decimales, redondea al primer decimal (por ejemplo, 4.15 se convierte en 4.2, 4.14 se convierte en 4.1).

3.  **PLANTILLA SCRIPT AUTOHOTKEY:**
    Genera una plantilla de script de AutoHotkey. ¬°ATENCI√ìN CR√çTICA AL DETALLE DEL ESPACIADO EN WINTITLE!
    En WinTitle debe tener 2 espacios luego de: (Services:)
    Delimita claramente el script de la siguiente manera:
    --- INICIO SCRIPT AUTOHOTKEY ---
    #SingleInstance force
    #NoEnv
    SendMode Input
    SetKeyDelay, 10
    WinTitle := "Oracle Fusion Middleware Forms Services:  Open > SHATRNS"
    WinWait, %WinTitle%
    WinActivate, %WinTitle%
    WinWaitActive, %WinTitle%
    ; La siguiente l√≠nea es un placeholder que ser√° reemplazado por el c√≥digo Python.
    (LINEA_ENCABEZADO_AQUI)
    ; Para cada materia extra√≠da de la TABLA DE DATOS (Materias) anterior, genera una l√≠nea Send con la siguiente estructura:
    Send, (letras del codigo){Tab}(n√∫meros del c√≥digo){Tab}{Tab}(calificaci√≥n){Tab}N{Down}{Space}{Tab}
    ; Para la √∫ltima materia, omite {Down}{Space}{Tab} al final.
    --- FIN SCRIPT AUTOHOTKEY ---

---
REGLAS Y EJEMPLOS PARA GENERAR 'ABREVIACION_SUGERIDA':
    OBJETIVO: Crear una abreviatura de M√ÅXIMO 30 caracteres.

    REGLA ESPECIAL Y PRIORITARIA:
      - **SI** el nombre completo del programa de origen **CONTIENE** las palabras `NORMALISTA SUPERIOR`, **ENTONCES** la `ABREVIACION_SUGERIDA` **DEBE SER EXACTAMENTE** `NORMALISTA SUPERIOR`.

    REGLAS GENERALES:
      1. Omitir art√≠culos (el, la, los, las), preposiciones comunes (de, en, a, por, para, con) y conjunciones (y, e, o, u) a menos que sean esenciales.
      2. Priorizar la legibilidad. No excedas los 30 caracteres.

    SUSTITUCIONES COMUNES:
      - TECNICO / T√âCNICO / TECNICA -> TC
      - TECNOLOGO / TECN√ìLOGO / TECNOLOGIA / TECNOLOG√çA -> TG
      - ESPECIALIZACION / ESPECIALIZACI√ìN -> ESP
      - LICENCIATURA -> LIC
      - M√ÅSTER / MASTER -> MA
      - INGENIERIA / INGENIER√çA -> ING
      - ADMINISTRACI√ìN / ADMINISTRATIVA / ADMINISTRATIVO -> ADMON / ADMIN
      - GESTION / GESTI√ìN -> GSTON / GSTN
      - CONTABLE / CONTABILIDAD / CONTABILIZACION -> CONT / CONTAB
      - FINANCIERA / FINANCIERO / FINANZAS -> FINAN / FINANC
      - DESARROLLO -> DESARR / DSRLLO
      - INFORMACI√ìN / INFORM√ÅTICA -> INFO / INFORM
      - SOFTWARE -> SOFT / SOFTW
      - SISTEMAS -> SIST / SISTE
      - PRIMERA INFANCIA -> PR INFANC / PRIM INFAN

    EJEMPLOS DE APLICACI√ìN:
      1.  "TECNICO EN CONTABILIZACION DE OPERACIONES COMERCIALES Y FINANCIERAS" -> "TC CONT OPER COMER Y FINANC"
      2.  "TECN√ìLOGO EN GESTION CONTABLE Y FINANCIERA" -> "TG GSTON CONTBLE Y FINACIRA"
      3.  "TECNOLOGO EN ANALISIS Y DESARROLLO DE SOFTWARE" -> "TG ANALISIS Y DESARR DE SOFTWA"
"""
PROMPT_ANALISIS_POSTGRADO = """Analiza el contenido del documento proporcionado (que ha sido convertido a texto, originado de un PDF o de un archivo Excel) y extrae los datos de c√≥digo y calificaci√≥n para cada una de las materias correspondientes a la secci√≥n: Programa Destino Ibero (que tambi√©n puede llamarse simplemente Programa Destino en algunas ocasiones). Aseg√∫rate de no incluir informaci√≥n de la secci√≥n Programa de Origen.
Igualmente revisa el dato correspondiente al periodo acad√©mico, programa al que aspira, el nombre completo del programa de origen y el n√∫mero correspondiente al total de cr√©ditos homologados.
CONDICIONES DE PARADA:
Revise los siguientes datos del documento: el periodo acad√©mico, el programa al que aspira y las calificaciones del "Programa Destino Ibero". Aplique las siguientes condiciones EN ORDEN. Si CUALQUIERA de estas condiciones se cumple, notif√≠quela claramente indicando la condici√≥n espec√≠fica y la etiqueta de detenci√≥n asociada, y NO contin√∫e con los pasos de "PROCESAMIENTO DE DATOS" ni "FORMATO DE SALIDA".
1.  **Condici√≥n de Periodo Acad√©mico:**
    *   Extraiga el valor del periodo acad√©mico del documento.
    *   **SI** la cadena de texto del periodo acad√©mico extra√≠do **CONTIENE EXACTAMENTE** la secuencia num√©rica "2024" (por ejemplo, "2024-1", "PERIODO 2024B", "202433"), ENTONCES:
        Notifique: "El periodo acad√©mico '{valor_del_periodo_extraido}' contiene '2024'."
        Indique: "DETENER_PROCESO_CONDICION_PERIODO"
        Y detenga todo procesamiento adicional.
    *   DE LO CONTRARIO (si "2024" no est√° presente en el periodo acad√©mico), contin√∫e con la siguiente condici√≥n de parada.
2.  **Condici√≥n de Calificaciones Bajas o en Blanco:**
    *   Analice las calificaciones de las materias del "Programa Destino Ibero".
    *   **SI** encuentra CUALQUIER materia en el "Programa Destino Ibero" con una calificaci√≥n en blanco (vac√≠a) O con un valor num√©rico inferior a 3.5 (por ejemplo 3.0, 3.4, 2.9, 1.5, 0.0), ENTONCES:
        Notifique: "Se encontr√≥ una calificaci√≥n no v√°lida para la materia '{nombre_materia_con_problema}' con calificaci√≥n '{calificacion_problematica}' en el Programa Destino Ibero."
        Indique: "DETENER_PROCESO_CONDICION_CALIFICACION"
        Y detenga todo procesamiento adicional.
    *   DE LO CONTRARIO, si todas las calificaciones son v√°lidas (3.5 o superior y no en blanco), proceda con los siguientes pasos.
Si NINGUNA de las condiciones de parada anteriores se cumple, Y SOLO EN ESE CASO, proceda con lo siguiente:
PROCESAMIENTO DE DATOS:
Ten en cuenta las siguientes recomendaciones al procesar los datos de las materias del "Programa Destino Ibero":
- Algunos c√≥digos pueden contener espacios; omite estos espacios para obtener solo letras y n√∫meros.
- En los c√≥digos de las materias, los n√∫meros siempre preceden a las letras. Adem√°s, en algunos casos, puede aparecer una letra "F" al final de los n√∫meros; esta letra debe ser omitida.
- Si el c√≥digo de la materia tiene un n√∫mero 0 al final de este debes preservarlo y no eliminarlo.
- Debemos traer al final los c√≥digos tal cual como aparecen en el archivo no debes cambiar los n√∫meros ni las letras de los c√≥digos.
FORMATO DE SALIDA (si no hay condiciones de parada):
1.  **DATOS CLAVE PARA RESUMEN (Presentar antes de la tabla y el script AHK):**
    *   **NOMBRE_ESTUDIANTE:** [Nombre completo del estudiante como aparece en el documento]
    *   **PROGRAMA_ASPIRA:** [Nombre completo del programa al que aspira el estudiante]
    *   **PLAN_ESTUDIO:** [N√∫mero o identificador del plan de estudio asociado al programa al que aspira, si se menciona. Indique "N/A"]
    *   **NOMBRE_PROGRAMA_ORIGEN:** [Nombre completo y exacto del programa de origen extra√≠do del documento]
    *   **CREDITOS_HOMOLOGADOS:** [N√∫mero total de cr√©ditos homologados extra√≠do del documento]
    *   **ABREVIACION_SUGERIDA:** [Genera una abreviatura para el NOMBRE_PROGRAMA_ORIGEN siguiendo las reglas de sustituci√≥n detalladas m√°s abajo. M√°ximo 30 caracteres.]

2.  **TABLA DE DATOS (Materias):**
    Crea una tabla con tres columnas para las materias del "Programa Destino Ibero":
    Primera columna: Contiene solamente las letras de los c√≥digos.
    Segunda columna: Contiene solamente los n√∫meros correspondientes a los c√≥digos.
    Tercera columna: Contiene las calificaciones correspondientes a cada c√≥digo.
    Las calificaciones deben formatearse siempre con un decimal:
    - Si la calificaci√≥n es un n√∫mero entero, debe mostrarse con dos decimales (por ejemplo, 4 debe ser 4.00).
    - Si la calificaci√≥n tiene un decimal, agrega un 0 a la derecha (por ejemplo, 4.1 se convierte en 4.10, 3.6 se convierte en 3.60).
    - Si la calificaci√≥n tiene dos decimales y el segundo decimal no es un cero, entonces se debe aproximar y dejar siempre con un cero como segundo decimal (por ejemplo, 4.45 se convierte en 4.50) 

3.  **PLANTILLA SCRIPT AUTOHOTKEY:**
    Genera una plantilla de script de AutoHotkey. ¬°ATENCI√ìN CR√çTICA AL DETALLE DEL ESPACIADO EN WINTITLE!
    En WinTitle debe tener 2 espacios luego de: (Services:)
    Delimita claramente el script de la siguiente manera:
    --- INICIO SCRIPT AUTOHOTKEY ---
    #SingleInstance force
    #NoEnv
    SendMode Input
    SetKeyDelay, 10
    WinTitle := "Oracle Fusion Middleware Forms Services:  Open > SHATRNS"
    WinWait, %WinTitle%
    WinActivate, %WinTitle%
    WinWaitActive, %WinTitle%
    ; La siguiente l√≠nea es un placeholder que ser√° reemplazado por el c√≥digo Python.
    (LINEA_ENCABEZADO_AQUI)
    ; Para cada materia extra√≠da de la TABLA DE DATOS (Materias) anterior, genera una l√≠nea Send con la siguiente estructura, ten encuenta que los parentesis son para indicar cada valor pero no incluyas los parentesis en las respuesta final:
    Send, (letras del codigo){Tab}(n√∫meros del c√≥digo){Tab}{Tab}(calificaci√≥n){Tab}P{Down}{Space}{Tab}
    ; Para la √∫ltima materia, omite {Down}{Space}{Tab} al final.
    --- FIN SCRIPT AUTOHOTKEY ---

---
REGLAS Y EJEMPLOS PARA GENERAR 'ABREVIACION_SUGERIDA':
    OBJETIVO: Crear una abreviatura de M√ÅXIMO 30 caracteres.

    REGLA ESPECIAL Y PRIORITARIA:
      - **SI** el nombre completo del programa de origen **CONTIENE** las palabras `NORMALISTA SUPERIOR`, **ENTONCES** la `ABREVIACION_SUGERIDA` **DEBE SER EXACTAMENTE** `NORMALISTA SUPERIOR`.

    REGLAS GENERALES:
      1. Omitir art√≠culos (el, la, los, las), preposiciones comunes (de, en, a, por, para, con) y conjunciones (y, e, o, u) a menos que sean esenciales.
      2. Priorizar la legibilidad. No excedas los 30 caracteres.

    SUSTITUCIONES COMUNES:
      - TECNICO / T√âCNICO / TECNICA -> TC
      - TECNOLOGO / TECN√ìLOGO / TECNOLOGIA / TECNOLOG√çA -> TG
      - ESPECIALIZACION / ESPECIALIZACI√ìN -> ESP
      - LICENCIATURA -> LIC
      - M√ÅSTER / MASTER -> MA
      - INGENIERIA / INGENIER√çA -> ING
      - ADMINISTRACI√ìN / ADMINISTRATIVA / ADMINISTRATIVO -> ADMON / ADMIN
      - GESTION / GESTI√ìN -> GSTON / GSTN
      - CONTABLE / CONTABILIDAD / CONTABILIZACION -> CONT / CONTAB
      - FINANCIERA / FINANCIERO / FINANZAS -> FINAN / FINANC
      - DESARROLLO -> DESARR / DSRLLO
      - INFORMACI√ìN / INFORM√ÅTICA -> INFO / INFORM
      - SOFTWARE -> SOFT / SOFTW
      - SISTEMAS -> SIST / SISTE
      - PRIMERA INFANCIA -> PR INFANC / PRIM INFAN

    EJEMPLOS DE APLICACI√ìN:
      1.  "TECNICO EN CONTABILIZACION DE OPERACIONES COMERCIALES Y FINANCIERAS" -> "TC CONT OPER COMER Y FINANC"
      2.  "TECN√ìLOGO EN GESTION CONTABLE Y FINANCIERA" -> "TG GSTON CONTBLE Y FINACIRA"
      3.  "TECNOLOGO EN ANALISIS Y DESARROLLO DE SOFTWARE" -> "TG ANALISIS Y DESARR DE SOFTWA"
"""
original_file_list_for_saving = []

NOTES_FILE = os.path.join(os.path.expanduser('~'), "notas_rapidas.txt")

def save_notes(text_widget, parent_window):
    """Guarda el contenido del widget de texto en un archivo."""
    try:
        notes_content = text_widget.get("1.0", tk.END)
        with open(NOTES_FILE, "w", encoding="utf-8") as f:
            f.write(notes_content)
        messagebox.showinfo("Notas Guardadas", f"Sus notas se han guardado correctamente en:\n{NOTES_FILE}", parent=parent_window)
    except Exception as e:
        messagebox.showerror("Error al Guardar", f"No se pudieron guardar las notas.\n\nError: {e}", parent=parent_window)

def load_notes(text_widget):
    """Carga las notas desde un archivo al widget de texto si el archivo existe."""
    try:
        if os.path.exists(NOTES_FILE):
            with open(NOTES_FILE, "r", encoding="utf-8") as f:
                content = f.read()
                text_widget.insert(tk.END, content)
    except Exception as e:
        print(f"Advertencia: No se pudieron cargar las notas. Error: {e}")

# --- CONFIGURACI√ìN DE PERSISTENCIA DE MODELOS ---
CONFIG_FILE = os.path.join(os.path.expanduser('~'), "ahk_processor_config.json")

def load_model_config():
    """Carga la configuraci√≥n de modelos seleccionados desde un archivo JSON."""
    try:
        if os.path.exists(CONFIG_FILE):
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
    except Exception as e:
        print(f"Advertencia: No se pudo cargar la configuraci√≥n de modelos. Usando valores por defecto. Error: {e}")
    return {}

def save_model_config(model_vars):
    """Guarda el estado actual de los checkboxes de modelos en un archivo JSON."""
    try:
        config_data = {name: var.get() for var, name in model_vars}
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config_data, f, indent=4)
        print(f"Configuraci√≥n de modelos guardada en: {CONFIG_FILE}")
    except Exception as e:
        print(f"Error al guardar la configuraci√≥n de modelos: {e}")

if __name__ == "__main__":
    ventana_principal_app = tk.Tk()
    ventana_principal_app.title("Procesador de Documentos AHK")
    # Geometr√≠a ajustada para incluir la secci√≥n de notas
    ventana_principal_app.geometry("950x600") 

    # --- MODIFICADO: Contenedor principal para dise√±o de dos columnas ---
    main_container = ttk.Frame(ventana_principal_app, padding="10")
    main_container.pack(expand=True, fill=tk.BOTH)

    # Frame izquierdo para los controles de procesamiento
    frame_izquierdo = ttk.Frame(main_container)
    frame_izquierdo.pack(side=tk.LEFT, expand=True, fill=tk.BOTH, padx=(0, 10))

    # Frame derecho para la nueva secci√≥n de notas
    frame_derecho = ttk.Frame(main_container)
    frame_derecho.pack(side=tk.RIGHT, expand=True, fill=tk.BOTH)

    # --- Controles originales movidos al frame izquierdo ---
    etiqueta_estado_gui = ttk.Label(frame_izquierdo, text="Listo para iniciar.", font=("Segoe UI", 10))
    etiqueta_estado_gui.pack(pady=5)
    
    model_frame = ttk.LabelFrame(frame_izquierdo, text="Selecci√≥n de Modelos Activos", padding="10")
    model_frame.pack(pady=10, padx=10, fill=tk.X)

    saved_config = load_model_config()
    model_checkbox_vars = []
    
    for model_name in WORKER_MODELS:
        is_selected = saved_config.get(model_name, True)
        var = tk.BooleanVar(value=is_selected) 
        cb = ttk.Checkbutton(model_frame, text=model_name, variable=var)
        cb.pack(anchor='w', padx=5)
        model_checkbox_vars.append((var, model_name))

    model_button_frame = ttk.Frame(model_frame)
    model_button_frame.pack(fill=tk.X, pady=(10, 0))

    def select_all_models():
        for var, _ in model_checkbox_vars:
            var.set(True)

    def deselect_all_models():
        for var, _ in model_checkbox_vars:
            var.set(False)

    select_all_button = ttk.Button(model_button_frame, text="Seleccionar Todos", command=select_all_models)
    select_all_button.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=(0, 5))

    deselect_all_button = ttk.Button(model_button_frame, text="Deseleccionar Todos", command=deselect_all_models)
    deselect_all_button.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=(5, 0))

    barra_progreso_gui = ttk.Progressbar(frame_izquierdo, orient="horizontal", length=300, mode="determinate")
    barra_progreso_gui.pack(pady=10)
    etiqueta_etr_gui = ttk.Label(frame_izquierdo, text="Tiempo restante: --:--", font=("Segoe UI", 9))
    etiqueta_etr_gui.pack(pady=5)
    
    botones_frame = ttk.Frame(frame_izquierdo)
    botones_frame.pack(pady=10)

    boton_ver_tabla_gui = ttk.Button(
        botones_frame,
        text="Ver √öltima Tabla de Resultados",
        command=lambda: show_last_results_table(ventana_principal_app)
    )
    boton_ver_tabla_gui.pack(pady=5)
    boton_ver_tabla_gui.config(state=tk.DISABLED)

    boton_seleccionar_gui = ttk.Button(
        botones_frame,
        text="Seleccionar Archivos y Procesar",
        command=lambda: iniciar_procesamiento_en_hilo(
            boton_seleccionar_gui, boton_ver_tabla_gui, etiqueta_estado_gui, barra_progreso_gui,
            etiqueta_etr_gui, ventana_principal_app, model_checkbox_vars
        )
    )
    boton_seleccionar_gui.pack(pady=5)

    # --- NUEVO: Secci√≥n de Notas en el frame derecho ---
    notes_frame = ttk.LabelFrame(frame_derecho, text="Notas R√°pidas", padding="10")
    notes_frame.pack(fill=tk.BOTH, expand=True)

    notes_text_area = scrolledtext.ScrolledText(notes_frame, wrap=tk.WORD, width=40, height=20, font=("Segoe UI", 9))
    notes_text_area.pack(pady=(0, 10), fill=tk.BOTH, expand=True)

    save_notes_button = ttk.Button(
        notes_frame, 
        text="Guardar Notas", 
        command=lambda: save_notes(notes_text_area, ventana_principal_app)
    )
    save_notes_button.pack(fill=tk.X)

    # Cargar las notas al iniciar la aplicaci√≥n
    load_notes(notes_text_area)

    # --- Verificaci√≥n de claves API (sin cambios) ---
    keys_faltantes = []
    if not LLMWHISPERER_API_KEY_1: keys_faltantes.append("LLMWHISPERER_API_KEY_1")
    if not OPENROUTER_API_KEY: keys_faltantes.append("OPENROUTER_API_KEY")
    if not GEMINI_API_KEY: keys_faltantes.append("GEMINI_API_KEY")

    if not OPENROUTER_API_KEY_2:
        print("ADVERTENCIA: No se encontr√≥ OPENROUTER_API_KEY_2 en .env. Fallback secundario de OpenRouter inactivo.")
    
    if keys_faltantes:
        mensaje_error = "ERROR: Faltan claves obligatorias en el archivo .env:\n\n" + "\n".join(keys_faltantes)
        etiqueta_estado_gui.config(text="ERROR: ¬°Configure las claves API en .env!")
        boton_seleccionar_gui.config(state=tk.DISABLED)
        messagebox.showerror("Error de Configuraci√≥n", mensaje_error, parent=ventana_principal_app)
    else:
        etiqueta_estado_gui.config(text=f"Claves OK. {len(WORKER_MODELS)} modelos activos detectados. Seleccione y procese.")

    def on_closing():
        save_model_config(model_checkbox_vars)
        ventana_principal_app.destroy()

    ventana_principal_app.protocol("WM_DELETE_WINDOW", on_closing)

    ventana_principal_app.mainloop()